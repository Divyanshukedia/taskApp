<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        .flatpickr-input {
            cursor: pointer;
        }
        .flatpickr-calendar.inline {
            display: block;
            width: 100%;
            max-height: 200px;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            background: white;
            box-shadow: none;
        }
        .flatpickr-time {
            height: auto;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: #f5f5f7;
            min-height: 100vh;
        }
        .sidebar {
            background: white;
            border-right: 1px solid #dee2e6;
            padding: 1.5rem;
            width: 250px;
            z-index: 1040;
        }
        .calendar-day {
            width: 100px;
            height: 100px;
            cursor: pointer;
            position: relative;
            font-weight: bold;
            overflow: hidden;
        }
        #calendar {
            table-layout: fixed;
            width: 100%;
        }
        .calendar-day:hover {
            background-color: rgba(0, 122, 255, 0.05);
        }
        .calendar-day.today {
            background-color: rgba(0, 122, 255, 0.1);
        }
        .calendar-day.selected {
            background-color: rgba(0, 122, 255, 0.15);
            border-color: #007bff;
        }
        .calendar-day.due-task {
            background-color: rgba(220, 53, 69, 0.2); /* Red background for due tasks */
        }
        .calendar-day .task-indicators {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 4px;
            justify-content: center;
            flex-wrap: wrap;
            width: 100%;
        }
        .calendar-day .task-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .calendar-day .task-dot.open {
            background-color: #007bff;
        }
        .calendar-day .task-dot.completed {
            background-color: #28a745;
        }
        .calendar-day .task-dot.due {
            background-color: #dc3545; /* Red dot for due tasks */
        }
        .calendar-day.has-tasks::after {
            display: none;
        }
        .task-item {
            border-left: 3px solid #007bff;
            transition: all 0.2s;
            cursor: pointer;
        }
        .task-item.completed {
            border-left-color: #28a745;
            opacity: 0.8;
        }
        .task-item.due {
            border-left-color: #dc3545; /* Red border for due tasks */
        }
        .task-priority {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .priority-high {
            background-color: #dc3545;
        }
        .priority-medium {
            background-color: #ff9500;
        }
        .priority-low {
            background-color: #28a745;
        }
        .type-call {
            background-color: #007bff;
        }
        .type-meeting {
            background-color: #ff9500;
        }
        .type-recurring {
            background-color: #6f42c1;
        }
        .profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 30px;
            color: #6c757d;
            cursor: pointer;
        }
        .profile-pic img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .task-history-table {
            font-size: 0.85em;
        }
        .calendar-day .task-titles {
            font-size: 0.7em;
            color: #6c757d;
            margin-top: 5px;
            height: 1.2em;
            width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.2em;
        }
        @media (max-width: 992px) {
            .sidebar {
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }
            .nav-link.active {
                background-color: #007bff;
                color: white !important;
                font-weight: 500;
            }
            .nav-link {
                color: #333;
                transition: all 0.2s ease;
            }
            .nav-link:hover {
                background-color: rgba(0, 123, 255, 0.1);
                color: #007bff;
            }
        }
        @media (max-width: 768px) {
            .calendar-day {
                width: 70px;
                height: 70px;
            }
            .task-history-table {
                font-size: 0.78em;
            }
            .calendar-day .task-titles {
                font-size: 0.6em;
                height: 1em;
                line-height: 1em;
            }
        }
        .nav-link.active {
            background-color: #007bff;
            color: white !important;
            font-weight: 500;
        }
        .nav-link {
            color: #333;
            transition: all 0.2s ease;
        }
        .nav-link:hover {
            background-color: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }
        @media (max-width: 991px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .nav-link.active {
                background-color: #007bff;
                color: white !important;
                font-weight: 500;
            }
            .nav-link {
                color: #333;
                transition: all 0.2s ease;
            }
            .nav-link:hover {
                background-color: rgba(0, 123, 255, 0.1);
                color: #007bff;
            }
            #main-content {
                margin-top: 50px;
            }
            .close-sidebar-btn {
                display: block;
            }
        }
        @media (min-width: 992px) {
            .sidebar {
                position: static;
                height: auto;
            }
            #toggle-sidebar-btn {
                display: none;
            }
            #main-content {
                margin-left: 250px;
                margin-top: 0;
            }
            .close-sidebar-btn {
                display: none;
            }
        }
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 1rem;
        }
        .dataTables_wrapper .dataTables_length {
            margin-bottom: 1rem;
        }
        .task-history-table th {
            position: relative;
            overflow: hidden;
            user-select: none;
        }
        .task-history-table th .resize-handle {
            position: absolute;
            top: 0;
            right: -5px;
            width: 10px;
            height: 100%;
            cursor: col-resize;
            z-index: 10;
        }
        .task-history-table th .resize-handle:hover {
            background: rgba(0, 123, 255, 0.2);
        }
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 1rem;
        }
        .dataTables_wrapper .dataTables_length {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="login-section" class="container">
        <div class="row justify-content-center">
            <div class="col-md-4 bg-white p-4 rounded shadow-sm mt-5">
                <h2 class="text-center mb-4">Login</h2>
                <form id="login-form">
                    <div class="mb-3">
                        <label for="login-email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="login-email" required>
                    </div>
                    <div class="mb-3">
                        <label for="login-password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="login-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Login</button>
                </form>
                <div class="text-center mt-3">
                    <a href="#" id="forgot-password-link" class="text-muted small">Forgot Password?</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="d-flex min-vh-100 d-none">
        <!-- Header with Hamburger -->
        <div class="d-flex align-items-start">
            <button class="btn btn-outline-secondary" id="toggle-sidebar-btn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <button class="btn btn-outline-danger mb-3 close-sidebar-btn d-lg-none" id="close-sidebar-btn">
                <i class="fas fa-times"></i> Close
            </button>
            <div class="text-center border-bottom pb-3 mb-3">
                <div class="profile-pic" id="profile-pic-container">
                    <div id="profile-pic-initial"><i class="fas fa-user"></i></div>
                    <img id="profile-pic-image" class="d-none" src="" alt="Profile">
                </div>
                <h5 id="profile-name" class="mb-1">User Name</h5>
                <p id="profile-email" class="text-muted small mb-2">user@example.com</p>
                <button class="btn btn-outline-primary btn-sm" id="edit-profile-btn">
                    <i class="fas fa-edit me-1"></i> Edit Profile
                </button>
            </div>
            <div class="nav-links flex-grow-1 d-flex flex-column">
                <a href="#" class="nav-link py-2 px-3 rounded mb-2 active" data-page="calendar">
                    <i class="fas fa-calendar me-2"></i> Calendar
                </a>
                <a href="#" class="nav-link py-2 px-3 rounded mb-2" data-page="tasks">
                    <i class="fas fa-tasks me-2"></i> All Tasks
                </a>
                <a href="#" class="nav-link py-2 px-3 rounded mb-2" data-page="recurring">
                    <i class="fas fa-redo me-2"></i> Recurring Events
                </a>
            </div>
            <div class="logout-btn py-2 px-3 rounded text-danger cursor-pointer">
                <i class="fas fa-sign-out-alt me-2"></i> Logout
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-grow-1 p-3">
            <!-- Calendar Page -->
            <div id="calendar-page" class="page-content">
                <div class="container bg-white p-4 rounded shadow-sm">
                    <div class="row g-0">
                        <div class="col-lg-8 p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2 id="current-month" class="mb-0"></h2>
                                <div>
                                    <button class="btn btn-outline-secondary btn-sm me-1" id="prev-month">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm me-1" id="today-btn">Today</button>
                                    <button class="btn btn-outline-secondary btn-sm" id="next-month">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-bordered" id="calendar">
                                    <thead>
                                        <tr class="text-center">
                                            <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
                                        </tr>
                                    </thead>
                                    <tbody id="calendar-body"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-lg-4 bg-light p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 id="tasks-date" class="mb-0">Tasks</h4>
                                <button class="btn btn-primary btn-sm" id="add-task-btn">
                                    <i class="fas fa-plus me-1"></i> Add Task
                                </button>
                            </div>
                            <div id="tasks-container">
                                <div class="alert alert-info d-none" id="no-tasks-message">
                                    No tasks for selected date. Click "Add Task" to create one.
                                </div>
                                <ul class="list-unstyled" id="tasks-list"></ul>
                            </div>
                            <div class="mt-3 d-none" id="task-details">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 id="task-detail-title" class="mb-0">Task Details</h5>
                                        <div>
                                            <button class="btn btn-sm btn-outline-secondary me-1" id="edit-task-btn">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger me-1" id="delete-task-btn">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-info" id="view-history-btn">
                                                <i class="fas fa-history"></i> View History
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <span class="badge bg-success me-2" id="task-status-badge">Pending</span>
                                            <span class="text-muted" id="task-time"></span>
                                        </div>
                                        <p id="task-description" class="mb-3"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile-page" class="page-content d-none">
                <div class="container bg-white p-4 rounded shadow-sm">
                    <h2 class="mb-4">Profile Settings</h2>
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div class="profile-pic mb-3" id="profile-pic-preview" style="width: 150px; height: 150px;">
                                <div id="profile-pic-preview-initial"><i class="fas fa-user" style="font-size: 60px;"></i></div>
                                <img id="profile-pic-preview-image" class="d-none" src="" alt="Profile">
                            </div>
                            <input type="file" id="profile-picture-input" accept="image/*" class="d-none">
                            <div class="d-flex flex-column align-items-center gap-2">
                                <button class="btn btn-outline-primary btn-sm" id="change-profile-pic-btn">
                                    <i class="fas fa-camera me-1"></i> Change Photo
                                </button>
                                <button type="button" class="btn btn-outline-warning" id="reset-password-btn">
                                    <i class="fas fa-key me-1"></i> Reset Password
                                </button>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <form id="profile-form">
                                <div class="mb-3">
                                    <label for="profile-name-input" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="profile-name-input" required>
                                </div>
                                <div class="mb-3">
                                    <label for="profile-email-input" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="profile-email-input" disabled>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="profile-gender" class="form-label">Gender</label>
                                        <select class="form-select" id="profile-gender">
                                            <option value="">Select</option>
                                            <option value="male">Male</option>
                                            <option value="female">Female</option>
                                            <option value="other">Other</option>
                                            <option value="prefer-not-to-say">Prefer not to say</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="profile-phone" class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="profile-phone">
                                    </div>
                                </div>
                                <div class="text-end">
                                    <button type="button" class="btn btn-secondary me-2" id="cancel-profile-btn">Cancel</button>
                                    <button type="submit" class="btn btn-primary" id="save-profile-btn">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Page -->
            <div id="tasks-page" class="page-content d-none">
                <div class="container bg-white p-4 rounded shadow-sm">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">All Tasks</h2>
                        <button class="btn btn-primary btn-sm" id="add-task-global-btn">
                            <i class="fas fa-plus me-1"></i> Add Task
                        </button>
                    </div>
                    <div class="all-tasks-container overflow-auto" style="max-height: 80vh;" id="all-tasks-container"></div>
                </div>
            </div>

            <!-- Recurring Events Page -->
            <div id="recurring-page" class="page-content d-none">
                <div class="container bg-white p-4 rounded shadow-sm">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">Recurring Events</h2>
                        <button class="btn btn-primary btn-sm" id="add-recurring-btn">
                            <i class="fas fa-plus me-1"></i> Add Recurring Event
                        </button>
                    </div>
                    <div id="recurring-events-container" class="overflow-auto" style="max-height: 70vh;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Task</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <input type="hidden" id="taskId">
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" id="taskTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Person Name</label>
                            <input type="text" class="form-control" id="personName" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">Start Time</label>
                                <div id="taskStartTime" class="flatpickr-time-container"></div>
                            </div>
                            <div class="col">
                                <label class="form-label">End Time</label>
                                <div id="taskEndTime" class="flatpickr-time-container"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="taskType">
                                <option value="call">Call</option>
                                <option value="meeting">Meeting</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="taskDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="saveTaskBtn">Save Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recurring Event Modal -->
    <div class="modal fade" id="recurringModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Recurring Event</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="recurringForm">
                        <input type="hidden" id="recurringId">
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" id="recurringTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Person Name</label>
                            <input type="text" class="form-control" id="recurringPersonName" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">Start Time</label>
                                <div id="recurringStartTime" class="flatpickr-time-container"></div>
                            </div>
                            <div class="col">
                                <label class="form-label">End Time</label>
                                <div id="recurringEndTime" class="flatpickr-time-container"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="recurringType">
                                <option value="call">Call</option>
                                <option value="meeting">Meeting</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Recurrence Pattern</label>
                            <select class="form-select" id="recurrencePattern" required>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly (Specific Date)</option>
                                <option value="monthly-day">Monthly (Specific Day)</option>
                            </select>
                        </div>
                        <div class="mb-3 d-none" id="weekly-options">
                            <label class="form-label">Days of the Week</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="week-sun" value="0">
                                <label class="form-check-label">Sunday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="week-mon" value="1">
                                <label class="form-check-label">Monday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="week-tue" value="2">
                                <label class="form-check-label">Tuesday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="week-wed" value="3">
                                <label class="form-check-label">Wednesday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="week-thu" value="4">
                                <label class="form-check-label">Thursday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="week-fri" value="5">
                                <label class="form-check-label">Friday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="week-sat" value="6">
                                <label class="form-check-label">Saturday</label>
                            </div>
                        </div>
                        <div class="mb-3 d-none" id="monthly-date-options">
                            <label class="form-label">Day of the Month</label>
                            <input type="number" class="form-control" id="monthlyDate" min="1" max="31" required>
                        </div>
                        <div class="mb-3 d-none" id="monthly-day-options">
                            <label class="form-label">Week and Day</label>
                            <div class="row">
                                <div class="col">
                                    <select class="form-select" id="monthlyWeek">
                                        <option value="1">First</option>
                                        <option value="2">Second</option>
                                        <option value="3">Third</option>
                                        <option value="4">Fourth</option>
                                        <option value="last">Last</option>
                                    </select>
                                </div>
                                <div class="col">
                                    <select class="form-select" id="monthlyDay">
                                        <option value="0">Sunday</option>
                                        <option value="1">Monday</option>
                                        <option value="2">Tuesday</option>
                                        <option value="3">Wednesday</option>
                                        <option value="4">Thursday</option>
                                        <option value="5">Friday</option>
                                        <option value="6">Saturday</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="recurringStartDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">End Date (Optional)</label>
                            <input type="date" class="form-control" id="recurringEndDate">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="saveRecurringBtn">Save Event</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Options Modal -->
    <div class="modal fade" id="editOptionsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Task</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <button class="btn btn-success w-100 mb-2" id="markCompletedBtn">Mark as Completed</button>
                    <button class="btn btn-primary w-100 mb-2" id="openFollowUpModalBtn">Add Follow-up</button>
                    <button class="btn btn-warning w-100" id="editTaskDetailsBtn">Edit Task Details</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Follow-up Modal -->
    <!-- Follow-up Modal -->
    <div class="modal fade" id="followUpModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Follow-up Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="followUpForm">
                <input type="hidden" id="originalTaskId">
                <div class="mb-3 d-none">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-control" id="followTitle" readonly>
                </div>
                <div class="row mb-3">
                    <div class="col">
                    <label class="form-label">Person Name</label>
                    <textarea class="form-control" id="followPersonName" rows="2" required></textarea>
                    </div>
                    <div class="col">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="followType" required>
                        <option value="call">Call</option>
                        <option value="meeting">Meeting</option>
                    </select>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col">
                    <label class="form-label">Start Time</label>
                    <div id="followStartTime" class="flatpickr-time-container"></div>
                    </div>
                    <div class="col">
                    <label class="form-label">End Time</label>
                    <div id="followEndTime" class="flatpickr-time-container"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Task Details</label>
                    <textarea class="form-control" id="followDescription" rows="3"></textarea>
                </div>
                <div class="row mb-3">
                    <div class="col">
                    <label class="form-label">Follow-up Date</label>
                    <input type="date" class="form-control" id="followUpDate" required>
                    </div>
                    <div class="col">
                    <label class="form-label">Attachment (optional)</label>
                    <input type="file" class="form-control" id="followAttachment"
                            accept="image/*,.pdf,.doc,.docx,.xls,.xlsx">
                    <small class="form-text text-muted">Images, PDF, DOC, XLS</small>
                    </div>
                </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveFollowUpBtn">Save Follow-up</button>
            </div>
            </div>
        </div>
    </div>

    <!-- Task History Modal -->
    <div class="modal fade" id="taskHistoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Task History</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="task-history-note"></p>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead id="task-history-table-head"></thead>
                            <tbody id="task-history-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <p id="task-completion-status" class="me-auto mb-0 text-muted"></p>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="completionDescriptionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="completionModalTitle"></h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="completionDescriptionForm">
                        <div class="mb-3">
                            <label for="completionDescription" class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="completionDescription" rows="4" placeholder="Enter any notes or details about this status change"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="saveCompletionDescriptionBtn">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="sidebar-overlay" class="position-fixed top-0 left-0 w-100 h-100 bg-dark opacity-50 d-none" style="z-index: 1025;"></div>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail, fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC87g6-ZLkXW9bPFy3Kn0ZASKYG-EiRArE",
            authDomain: "eventseatmanagement.firebaseapp.com",
            projectId: "eventseatmanagement",
            storageBucket: "eventseatmanagement.firebasestorage.app",
            messagingSenderId: "911745257961",
            appId: "1:911745257961:web:2759656a91df70fd5dbb78",
            measurementId: "G-9K4SXKD384"
        };
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app, "gs://eventseatmanagement.firebasestorage.app");

        // App logic
        $(() => {
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            let currentDate = new Date();
            let selectedDate = new Date();
            let selectedTask = null;
            let tasks = {};
            let recurringEvents = {};
            let currentUser = null;
            let userProfileData = {};
            const taskModal = new bootstrap.Modal('#taskModal');
            const recurringModal = new bootstrap.Modal('#recurringModal');
            const editOptionsModal = new bootstrap.Modal('#editOptionsModal');
            const followUpModal = new bootstrap.Modal('#followUpModal');
            const taskHistoryModal = new bootstrap.Modal('#taskHistoryModal');
            const completionDescriptionModal = new bootstrap.Modal('#completionDescriptionModal');
            let flatpickrInstances = {};


            // New function to validate time range
            const validateTimeRange = (startTime, endTime) => {
                if (!startTime || !endTime) return true; // No validation if either time is missing (all-day task)
                const regex = /^(\d{1,2}):(\d{2})\s*(AM|PM)$/i;
                const startMatch = startTime.match(regex);
                const endMatch = endTime.match(regex);
                if (!startMatch || !endMatch) return false;

                let startHours = parseInt(startMatch[1]);
                const startMinutes = parseInt(startMatch[2]);
                const startPeriod = startMatch[3].toUpperCase();
                if (startPeriod === 'PM' && startHours !== 12) startHours += 12;
                if (startPeriod === 'AM' && startHours === 12) startHours = 0;
                const startTotalMinutes = startHours * 60 + startMinutes;

                let endHours = parseInt(endMatch[1]);
                const endMinutes = parseInt(endMatch[2]);
                const endPeriod = endMatch[3].toUpperCase();
                if (endPeriod === 'PM' && endHours !== 12) endHours += 12;
                if (endPeriod === 'AM' && endHours === 12) endHours = 0;
                const endTotalMinutes = endHours * 60 + endMinutes;

                return endTotalMinutes > startTotalMinutes;
            };
            const initFlatpickr = () => {
                ['taskStartTime', 'taskEndTime', 'recurringStartTime', 'recurringEndTime', 'followStartTime', 'followEndTime'].forEach(id => {
                    if (flatpickrInstances[id]) flatpickrInstances[id].destroy();
                    flatpickrInstances[id] = flatpickr(`#${id}`, {
                        enableTime: true,
                        noCalendar: true,
                        dateFormat: "h:i K",
                        time_24hr: false,
                        minuteIncrement: 10,
                        inline: true,
                        onChange: function(selectedDates, dateStr, instance) {
                            instance.element.dataset.time = dateStr;
                        },
                        onOpen: function(selectedDates, dateStr, instance) {
                            const timeContainer = instance.calendarContainer.querySelector('.flatpickr-time');
                            if (timeContainer) {
                                timeContainer.addEventListener('wheel', (e) => {
                                    e.preventDefault();
                                    const delta = e.deltaY > 0 ? 10 : -10;
                                    const currentTime = new Date(selectedDates[0] || new Date());
                                    currentTime.setMinutes(currentTime.getMinutes() + delta);
                                    instance.setDate(currentTime, true);
                                });
                            }
                        },
                        onValueUpdate: function(selectedDates, dateStr, instance) {
                            if (dateStr) {
                                const regex = /^(\d{1,2}):(\d{2})\s*(AM|PM)$/i;
                                const match = dateStr.match(regex);
                                if (match) {
                                    let hours = parseInt(match[1]);
                                    const minutes = parseInt(match[2]);
                                    const period = match[3].toUpperCase();
                                    if (period === 'PM' && hours !== 12) hours += 12;
                                    if (period === 'AM' && hours === 12) hours = 0;
                                    const snappedMinutes = Math.round(minutes / 10) * 10;
                                    let newHours = hours;
                                    let newMinutes = snappedMinutes;
                                    if (snappedMinutes >= 60) {
                                        newHours += 1;
                                        newMinutes = 0;
                                    }
                                    newHours = Math.min(23, Math.max(0, newHours));
                                    const displayHours = newHours % 12 === 0 ? 12 : newHours % 12;
                                    const newPeriod = newHours >= 12 ? 'PM' : 'AM';
                                    const newTime = `${displayHours}:${String(newMinutes).padStart(2, '0')} ${newPeriod}`;
                                    if (newTime !== dateStr) {
                                        instance.setDate(newTime, true);
                                    }
                                }
                            }
                            instance.element.dataset.time = dateStr;
                        }
                    });
                });
            };

            const getImmediateFollowUp = (taskId) => {
                const taskData = findTask(taskId);
                if (!taskData || !taskData.task.followUps || taskData.task.followUps.length === 0) return null;
                const followUpId = taskData.task.followUps[0].id;
                return findTask(followUpId);
            };
            const getFlatpickrTime = (id) => {
                const instance = flatpickrInstances[id];
                return instance && instance.element.dataset.time ? instance.element.dataset.time : '';
            };
            const setFlatpickrTime = (id, timeStr) => {
                const instance = flatpickrInstances[id];
                if (instance) {
                    if (timeStr && timeStr.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i)) {
                        instance.setDate(timeStr, true);
                        instance.element.dataset.time = timeStr;
                    } else {
                        instance.clear();
                        instance.element.dataset.time = '';
                    }
                }
            };
            $('#taskModal').on('shown.bs.modal', initFlatpickr);
            $('#recurringModal').on('shown.bs.modal', initFlatpickr);
            $('#followUpModal').on('shown.bs.modal', initFlatpickr);
            $('#toggle-sidebar-btn').click(() => {
                $('#sidebar').addClass('active');
                $('#sidebar-overlay').removeClass('d-none');
            });

            $('#close-sidebar-btn, #sidebar-overlay').click(() => {
                $('#sidebar').removeClass('active');
                $('#sidebar-overlay').addClass('d-none');
            });

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    $('#login-section').addClass('d-none');
                    $('#app-container').removeClass('d-none');
                    await loadUserProfile();
                    updateProfileDisplay();
                    loadUserTasks();
                    loadRecurringEvents();
                    $('#login-form')[0].reset();
                } else {
                    currentUser = null;
                    $('#login-section').removeClass('d-none');
                    $('#app-container').addClass('d-none');
                    tasks = {};
                    recurringEvents = {};
                    selectedTask = null;
                }
            });

            const loadUserProfile = async () => {
                if (!currentUser) return;
                const profileRef = doc(db, 'users', currentUser.uid, 'private', 'profile');
                const docSnap = await getDoc(profileRef);
                userProfileData = docSnap.exists() ? docSnap.data() : {
                    name: currentUser.displayName || '',
                    email: currentUser.email,
                    gender: '',
                    phone: '',
                    photoURL: currentUser.photoURL || ''
                };
                if (!docSnap.exists()) await setDoc(profileRef, userProfileData);
            };

            const saveUserProfile = async () => {
                if (!currentUser) return false;
                const profileRef = doc(db, 'users', currentUser.uid, 'private', 'profile');
                try {
                    await updateDoc(profileRef, userProfileData);
                    if (userProfileData.name || userProfileData.photoURL) {
                        await updateProfile(currentUser, {
                            displayName: userProfileData.name,
                            photoURL: userProfileData.photoURL
                        });
                    }
                    return true;
                } catch (error) {
                    console.error("Error saving profile:", error);
                    return false;
                }
            };

            const updateProfileDisplay = () => {
                if (!currentUser) return;
                $('#profile-name').text(userProfileData.name || 'User Name');
                $('#profile-email').text(userProfileData.email || 'user@example.com');
                $('#profile-name-input').val(userProfileData.name || '');
                $('#profile-email-input').val(userProfileData.email || '');
                $('#profile-gender').val(userProfileData.gender || '');
                $('#profile-phone').val(userProfileData.phone || '');

                const updatePic = (initial, image, container) => {
                    if (userProfileData.photoURL) {
                        initial.addClass('d-none');
                        image.removeClass('d-none').attr('src', userProfileData.photoURL);
                    } else {
                        initial.removeClass('d-none').text(userProfileData.name ? userProfileData.name.charAt(0).toUpperCase() : 'U');
                        image.addClass('d-none');
                    }
                };
                updatePic($('#profile-pic-initial'), $('#profile-pic-image'), $('#profile-pic-container'));
                updatePic($('#profile-pic-preview-initial'), $('#profile-pic-preview-image'), $('#profile-pic-preview'));
            };

            const uploadProfilePicture = async (file) => {
                if (!currentUser) return null;
                const storageRef = ref(storage, `profile-pictures/${currentUser.uid}`);
                await uploadBytes(storageRef, file);
                return await getDownloadURL(storageRef);
            };

            const loadUserTasks = () => {
                if (!currentUser) return;
                onSnapshot(collection(db, 'users', currentUser.uid, 'tasks'), snapshot => {
                    tasks = {};
                    snapshot.forEach(doc => tasks[doc.id] = doc.data().items || []);
                    renderCalendar();
                    if ($('#tasks-page').hasClass('active')) renderAllTasks();
                });
            };

            const saveTasks = async (date, taskList) => {
                if (!currentUser) return;
                const tasksRef = doc(db, 'users', currentUser.uid, 'tasks', date);
                try {
                    await setDoc(tasksRef, { items: taskList }, { merge: false });
                } catch (error) {
                    console.error(`Error saving tasks for ${date}:`, error);
                }
            };

            const findTask = (taskId) => {
                for (const date in tasks) {
                    const task = tasks[date].find(t => String(t.id) === String(taskId));
                    if (task) return { task, date };
                }
                return null;
            };

            const loadRecurringEvents = () => {
                if (!currentUser) return;
                onSnapshot(collection(db, 'users', currentUser.uid, 'recurringEvents'), snapshot => {
                    recurringEvents = {};
                    snapshot.forEach(doc => {
                        recurringEvents[doc.id] = doc.data();
                    });
                    renderCalendar();
                    if ($('#recurring-page').hasClass('active')) renderRecurringEvents();
                });
            };

            const saveRecurringEvent = async (eventId, eventData) => {
                if (!currentUser) return;
                if (eventData.pattern === 'weekly' && (!eventData.days || !Array.isArray(eventData.days))) {
                    console.error('Invalid days array for weekly recurring event');
                    return;
                }
                // Ensure exceptions array exists
                eventData.exceptions = eventData.exceptions || [];
                const eventRef = doc(db, 'users', currentUser.uid, 'recurringEvents', eventId);
                try {
                    await setDoc(eventRef, eventData, { merge: true });
                } catch (error) {
                    console.error(`Error saving recurring event ${eventId}:`, error);
                }
            };

            const deleteRecurringEvent = async (eventId) => {
                if (!currentUser) return;
                const eventRef = doc(db, 'users', currentUser.uid, 'recurringEvents', eventId);
                try {
                    await deleteDoc(eventRef);
                } catch (error) {
                    console.error(`Error deleting recurring event ${eventId}:`, error);
                }
            };


            const getRecurringInstances = (date) => {
                const instances = [];
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDayOfMonth = new Date(year, month, 1, 0, 0, 0, 0);
                const lastDayOfMonth = new Date(year, month + 1, 0, 0, 0, 0, 0);
                const seenInstanceIds = new Set();

                Object.entries(recurringEvents).forEach(([id, event]) => {
                    const startDate = new Date(event.startDate);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = event.endDate ? new Date(event.endDate) : null;
                    if (endDate) endDate.setHours(0, 0, 0, 0);
                    const pattern = event.pattern;
                    const exceptions = event.exceptions || []; // Array of dates to exclude

                    const isWithinRange = (d) => {
                        const dDate = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0);
                        const start = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate(), 0, 0, 0, 0);
                        const end = endDate ? new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate(), 0, 0, 0, 0) : null;
                        const first = new Date(firstDayOfMonth.getFullYear(), firstDayOfMonth.getMonth(), firstDayOfMonth.getDate(), 0, 0, 0, 0);
                        const last = new Date(lastDayOfMonth.getFullYear(), lastDayOfMonth.getMonth(), lastDayOfMonth.getDate(), 0, 0, 0, 0);

                        const dateStr = formatDate(dDate);
                        return (
                            (!end || dDate <= end) &&
                            dDate >= start &&
                            dDate >= first &&
                            dDate <= last &&
                            !exceptions.includes(dateStr) // Exclude dates in exceptions array
                        );
                    };

                    if (pattern === 'weekly') {
                        const days = event.days || [];
                        const loopStart = startDate > firstDayOfMonth ? new Date(startDate) : new Date(firstDayOfMonth);
                        loopStart.setHours(0, 0, 0, 0);
                        const loopEnd = endDate && endDate < lastDayOfMonth ? new Date(endDate) : new Date(lastDayOfMonth);
                        loopEnd.setHours(0, 0, 0, 0);

                        let currentDate = new Date(loopStart);
                        while (currentDate <= loopEnd) {
                            const dayOfWeek = currentDate.getDay();
                            if (days.includes(dayOfWeek) && isWithinRange(currentDate)) {
                                const dateStr = formatDate(currentDate);
                                const instanceId = `${id}_${dateStr}`;
                                if (!seenInstanceIds.has(instanceId)) {
                                    instances.push({
                                        eventId: id,
                                        date: new Date(currentDate),
                                        task: { ...event, id: instanceId, isRecurring: true }
                                    });
                                    seenInstanceIds.add(instanceId);
                                }
                            }
                            currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate() + 1, 0, 0, 0, 0);
                        }
                    } else if (pattern === 'daily') {
                        const loopStart = startDate > firstDayOfMonth ? new Date(startDate) : new Date(firstDayOfMonth);
                        loopStart.setHours(0, 0, 0, 0);
                        const loopEnd = endDate && endDate < lastDayOfMonth ? new Date(endDate) : new Date(lastDayOfMonth);
                        loopEnd.setHours(0, 0, 0, 0);

                        let currentDate = new Date(loopStart);
                        while (currentDate <= loopEnd) {
                            if (isWithinRange(currentDate)) {
                                const dateStr = formatDate(currentDate);
                                const instanceId = `${id}_${dateStr}`;
                                if (!seenInstanceIds.has(instanceId)) {
                                    instances.push({
                                        eventId: id,
                                        date: new Date(currentDate),
                                        task: { ...event, id: instanceId, isRecurring: true }
                                    });
                                    seenInstanceIds.add(instanceId);
                                }
                            }
                            currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate() + 1, 0, 0, 0, 0);
                        }
                    } else if (pattern === 'monthly') {
                        const day = event.day;
                        const targetDate = new Date(year, month, day, 0, 0, 0, 0);
                        if (targetDate.getMonth() === month && isWithinRange(targetDate)) {
                            const instanceId = `${id}_${formatDate(targetDate)}`;
                            if (!seenInstanceIds.has(instanceId)) {
                                instances.push({
                                    eventId: id,
                                    date: new Date(targetDate),
                                    task: { ...event, id: instanceId, isRecurring: true }
                                });
                                seenInstanceIds.add(instanceId);
                            }
                        }
                    } else if (pattern === 'monthly-day') {
                        const week = event.week;
                        const day = event.day;
                        let targetDate;
                        if (week === 'last') {
                            const lastDay = new Date(year, month + 1, 0, 0, 0, 0, 0);
                            targetDate = new Date(lastDay);
                            targetDate.setDate(lastDay.getDate() - ((lastDay.getDay() - day + 7) % 7));
                            targetDate.setHours(0, 0, 0, 0);
                        } else {
                            const firstDay = new Date(year, month, 1, 0, 0, 0, 0);
                            targetDate = new Date(year, month, 1 + (week - 1) * 7, 0, 0, 0, 0);
                            targetDate.setDate(targetDate.getDate() + ((day - targetDate.getDay() + 7) % 7));
                            targetDate.setHours(0, 0, 0, 0);
                        }
                        if (targetDate.getMonth() === month && isWithinRange(targetDate)) {
                            const instanceId = `${id}_${formatDate(targetDate)}`;
                            if (!seenInstanceIds.has(instanceId)) {
                                instances.push({
                                    eventId: id,
                                    date: new Date(targetDate),
                                    task: { ...event, id: instanceId, isRecurring: true }
                                });
                                seenInstanceIds.add(instanceId);
                            }
                        }
                    }
                });

                return instances;
            };
            const isTaskDue = (task, taskDate) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const taskDateObj = new Date(taskDate);
                taskDateObj.setHours(0, 0, 0, 0);
                return (
                    !task.completed &&
                    (!task.followUps || task.followUps.length === 0) &&
                    taskDateObj < today
                );
            };

            const renderCalendar = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                $('#current-month').text(`${monthNames[month]} ${year}`);

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let date = 1;
                let calendarBody = '';

                const monthTasks = {};
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = formatDate(new Date(year, month, d));
                    monthTasks[dateStr] = tasks[dateStr] || [];
                }
                getRecurringInstances(currentDate).forEach(({ date, task }) => {
                    const dateStr = formatDate(date);
                    monthTasks[dateStr] = monthTasks[dateStr] || [];
                    if (!monthTasks[dateStr].some(t => t.id === task.id)) {
                        monthTasks[dateStr].push(task);
                    }
                });

                for (let i = 0; i < 6 && date <= daysInMonth; i++) {
                    calendarBody += '<tr>';
                    for (let j = 0; j < 7; j++) {
                        if (i === 0 && j < firstDay || date > daysInMonth) {
                            calendarBody += '<td class="calendar-day empty"></td>';
                        } else {
                            const dateStr = formatDate(new Date(year, month, date));
                            const hasDueTask = monthTasks[dateStr]?.some(task => isTaskDue(task, dateStr));
                            const classes = [
                                'calendar-day',
                                isSameDay(new Date(year, month, date), new Date()) ? 'today' : '',
                                isSameDay(new Date(year, month, date), selectedDate) ? 'selected' : '',
                                monthTasks[dateStr]?.length > 0 ? 'has-tasks' : '',
                                hasDueTask ? 'due-task' : ''
                            ].filter(Boolean).join(' ');

                            const taskDots = monthTasks[dateStr]?.map(task => {
                                const isDue = isTaskDue(task, dateStr);
                                const statusClass = isDue ? 'due' : task.completed ? 'completed' : 'open';
                                return `<span class="task-dot ${statusClass}"></span>`;
                            }).join('') || '';

                            const taskTitles = monthTasks[dateStr]?.map(task => {
                                const fullTitle = task.title;
                                const displayWord = fullTitle.length > 5 ? fullTitle.substring(0, 5) + '..' : fullTitle;
                                return { display: displayWord, full: fullTitle };
                            }).filter(t => t.full);
                            const displayText = taskTitles?.map(t => t.display).join(', ') || '';
                            const fullText = taskTitles?.map(t => t.full).join(', ') || '';

                            calendarBody += `
                                <td class="${classes}" data-date="${dateStr}">
                                    <div>${date}</div>
                                    ${displayText ? `<div class="task-titles" title="${fullText}">${displayText}</div>` : ''}
                                    <div class="task-indicators">${taskDots}</div>
                                </td>`;
                            date++;
                        }
                    }
                    calendarBody += '</tr>';
                }
                $('#calendar-body').html(calendarBody);
                updateTasksPanel();
            };

            const updateTasksPanel = () => {
                const dateStr = formatDate(selectedDate);
                const recurringInstances = getRecurringInstances(selectedDate)
                    .filter(i => isSameDay(i.date, selectedDate))
                    .map(i => i.task);

                const allTasks = (tasks[dateStr] || []).concat(recurringInstances);
                const uniqueTasks = [];
                const seenTaskIds = new Set();

                allTasks.forEach(task => {
                    if (!seenTaskIds.has(task.id)) {
                        uniqueTasks.push(task);
                        seenTaskIds.add(task.id);
                    }
                });

                // Helper function to parse time string to minutes for comparison
                const parseTimeToMinutes = (timeStr) => {
                    if (!timeStr) return Infinity; // All-day tasks (no time) go to the end
                    const regex = /^(\d{1,2}):(\d{2})\s*(AM|PM)$/i;
                    const match = timeStr.match(regex);
                    if (!match) return Infinity;
                    let hours = parseInt(match[1]);
                    const minutes = parseInt(match[2]);
                    const period = match[3].toUpperCase();
                    if (period === 'PM' && hours !== 12) hours += 12;
                    if (period === 'AM' && hours === 12) hours = 0;
                    return hours * 60 + minutes;
                };

                // Sort tasks by start time (ascending)
                uniqueTasks.sort((a, b) => {
                    const timeA = parseTimeToMinutes(a.time?.start);
                    const timeB = parseTimeToMinutes(b.time?.start);
                    return timeA - timeB;
                });

                $('#tasks-date').text(selectedDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }));
                $('#no-tasks-message').toggleClass('d-none', uniqueTasks.length > 0);
                $('#tasks-list').empty();
                $('#tasks-list').html(uniqueTasks.map(task => {
                    const isDue = isTaskDue(task, dateStr);
                    return `
                        <li class="task-item p-3 mb-2 bg-white rounded shadow-sm ${task.completed ? 'completed' : isDue ? 'due' : ''}" data-task-id="${task.id}" data-is-recurring="${task.isRecurring || false}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <span class="${task.isRecurring ? 'type-recurring' : `type-${task.type || 'call'}`} task-priority"></span>
                                    <strong>${task.title}</strong>
                                    ${isDue ? '<span class="badge bg-danger ms-2">Due</span>' : ''}
                                </div>
                                <small class="text-muted">${task.time?.start ? `${task.time.start} - ${task.time.end}` : 'All day'}</small>
                            </div>
                            ${task.description ? `<p class="mt-2 mb-0 text-muted small">${task.description}</p>` : ''}
                        </li>
                    `;
                }).join(''));
                $('#task-details').toggleClass('d-none', !selectedTask);
            };

            const showTaskDetails = (task, taskDate) => {
                selectedTask = task;
                selectedDate = new Date(taskDate);
                $('#task-detail-title').text(task.title);
                $('#task-description').html(task.description || '<p class="text-muted">No description provided.</p>');
                $('#task-time').text(task.time?.start ? `${formatDate(selectedDate)}, ${task.time.start} - ${task.time.end}` : 'All day');
                $('#task-status-badge').removeClass('bg-success bg-secondary bg-danger')
                    .addClass(task.completed ? 'bg-success' : isTaskDue(task, taskDate) ? 'bg-danger' : 'bg-secondary')
                    .text(task.completed ? 'Completed' : isTaskDue(task, taskDate) ? 'Due' : 'Pending');
                renderCalendar();
            };

            const findRootTask = (taskId) => {
                let currentTask = findTask(taskId);
                while (currentTask && currentTask.task.followUpFrom) {
                    currentTask = findTask(currentTask.task.followUpFrom);
                    if (!currentTask) break;
                }
                return currentTask;
            };

            const getAllDescendantTasks = (rootTask, visited = new Set()) => {
                if (!rootTask || visited.has(rootTask.task.id)) return [];
                visited.add(rootTask.task.id);
                let descendants = [rootTask];
                if (rootTask.task.followUps) {
                    rootTask.task.followUps.forEach(followUp => {
                        const followUpTask = findTask(followUp.id);
                        if (followUpTask) {
                            descendants = descendants.concat(getAllDescendantTasks(followUpTask, visited));
                        }
                    });
                }
                return descendants;
            };

             const uploadFile = async (file, path) => {
                if (!currentUser || !file) return null;
                const storageRef = ref(storage, path);
                await uploadBytes(storageRef, file);
                return await getDownloadURL(storageRef);
            };

            // Existing functions up to getRelatedTasks
            const getRelatedTasks = (taskId) => {
                const rootTask = findRootTask(taskId);
                if (!rootTask) return [];
                const allTasks = getAllDescendantTasks(rootTask);
                allTasks.sort((a, b) => a.date.localeCompare(b.date));
                return allTasks.map(({ task, date }, index) => {
                    const followUpTask = getImmediateFollowUp(task.id);
                    let notes = followUpTask ? (followUpTask.task.description || '-') : '-';
                    let attachment = task.attachment || null;

                    // If this task has a follow-up, assign the follow-up's attachment to this task's entry
                    if (followUpTask && followUpTask.task.attachment && !task.followUpFrom) {
                        attachment = followUpTask.task.attachment;
                    }
                    // If this task is a follow-up, do not show its own attachment
                    if (task.followUpFrom) {
                        attachment = null;
                    }

                    if (task.history) {
                        const completionEntry = task.history
                            .filter(entry => entry.action === 'Marked as completed' || entry.action === 'Marked as incomplete')
                            .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                        if (completionEntry && completionEntry.changes?.description) {
                            notes = completionEntry.changes.description;
                        }
                    }

                    return {
                        id: task.id,
                        date: date,
                        time: task.time?.start ? `${task.time.start} - ${task.time.end}` : 'All day',
                        type: task.type || 'N/A',
                        personName: task.personName || 'N/A',
                        notes: notes,
                        attachment: attachment
                    };
                });
            };
            const renderHistoryTable = (historyItems, title) => {
                $('#task-history-note').text(title || 'Task History');
                $('#task-history-table-head').html(`
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Person Name</th>
                        <th>Notes</th>
                        <th>Attachment</th>
                    </tr>
                `);
                const tbody = $('#task-history-table-body').empty();
                historyItems.forEach((item, index) => {
                    const entryDate = new Date(item.date);
                    const timeStr = item.time || 'All day';
                    const formattedDate = entryDate.toLocaleDateString('en-GB', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                    const notes = (item.action === 'Marked as completed' || item.action === 'Marked as incomplete') && item.changes?.description
                        ? item.changes.description
                        : item.notes && item.notes !== '-' ? item.notes
                        : item.action ? item.action
                        : '-';
                    const isRecurring = item.isRecurring || (item.taskId && item.taskId.includes('_'));
                    const taskId = item.taskId || (isRecurring ? item.eventId + '_' + item.date : item.id);
                    const attachmentCell = item.attachment
                        ? `<a href="${item.attachment.url}" target="_blank" download="${item.attachment.name}">${item.attachment.name}</a>`
                        : '-';
                    const row = `
                        <tr class="history-row" 
                            data-task-id="${taskId || ''}" 
                            data-date="${item.date}" 
                            data-is-recurring="${isRecurring ? 'true' : 'false'}"
                            style="cursor: pointer;">
                            <td>${formattedDate}</td>
                            <td>${timeStr}</td>
                            <td>${item.type || 'N/A'}</td>
                            <td>${item.personName || 'N/A'}</td>
                            <td>${notes}</td>
                            <td>${attachmentCell}</td>
                        </tr>
                    `;
                    tbody.append(row);
                });
                if (!historyItems.length) {
                    tbody.append('<tr><td colspan="6" class="text-muted">No history available</td></tr>');
                }

                let completionStatus = '';
                const statusEntries = historyItems
                    .filter(item => 
                        item.action === 'Marked as completed' && item.changes?.completed?.new === true ||
                        item.action === 'Marked as incomplete' && item.changes?.completed?.new === false
                    )
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                if (statusEntries.length > 0) {
                    const latestEntry = statusEntries[0];
                    const statusDate = new Date(latestEntry.date).toLocaleDateString('en-GB', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                    if (latestEntry.action === 'Marked as completed') {
                        completionStatus = `Task closed on ${statusDate}`;
                    } else if (latestEntry.action === 'Marked as incomplete') {
                        completionStatus = `Task reopened on ${statusDate}`;
                    }
                }
                $('#task-completion-status').text(completionStatus);
            };
            $(document).on('click', '.history-row', function() {
                const taskId = $(this).data('task-id');
                const dateStr = $(this).data('date');
                const isRecurring = $(this).data('is-recurring') === true;

                if (!taskId || !dateStr) return;

                taskHistoryModal.hide();

                if (isRecurring) {
                    const eventId = taskId.split('_')[0];
                    const event = recurringEvents[eventId];
                    if (event) {
                        selectedTask = { ...event, id: taskId, isRecurring: true };
                        selectedDate = new Date(dateStr);
                        currentDate = new Date(dateStr);
                        renderCalendar();
                        showTaskDetails(selectedTask, dateStr);
                        $('#task-details').removeClass('d-none');
                        showPage('calendar-page');
                    }
                } else {
                    const taskData = findTask(taskId);
                    if (taskData) {
                        selectedTask = taskData.task;
                        selectedDate = new Date(dateStr);
                        currentDate = new Date(dateStr);
                        renderCalendar();
                        showTaskDetails(taskData.task, dateStr);
                        $('#task-details').removeClass('d-none');
                        showPage('calendar-page');
                    }
                }
            });
            $('#view-history-btn').click(() => {
                if (!selectedTask) return;
                let historyItems = [];
                let title = selectedTask.title || 'Untitled Task';
                const seenEntries = new Set();

                if (selectedTask.isRecurring) {
                    const eventId = selectedTask.id.split('_')[0];
                    const event = recurringEvents[eventId];
                    if (event) {
                        const baseEntryKey = `${event.startDate}_base`;
                        if (!seenEntries.has(baseEntryKey)) {
                            historyItems.push({
                                eventId,
                                isRecurring: true,
                                date: event.startDate,
                                time: event.time?.start ? `${event.time.start} - ${event.time.end}` : 'All day',
                                type: event.type || 'Recurring',
                                personName: event.personName || 'N/A',
                                notes: event.followUps && event.followUps.length > 0 ? event.followUps[0].description || '-' : '-',
                                attachment: event.attachment || null
                            });
                            seenEntries.add(baseEntryKey);
                        }

                        if (event.followUps && event.followUps.length > 0) {
                            event.followUps.forEach((followUp, index) => {
                                const nextFollowUp = event.followUps[index + 1];
                                const followUpKey = `${followUp.date}_followup_${followUp.id}`;
                                if (!seenEntries.has(followUpKey)) {
                                    historyItems.push({
                                        eventId,
                                        isRecurring: true,
                                        date: followUp.date,
                                        time: followUp.time?.start ? `${followUp.time.start} - ${followUp.time.end}` : 'All day',
                                        type: followUp.type || 'Follow-up',
                                        personName: followUp.personName || 'N/A',
                                        notes: nextFollowUp ? nextFollowUp.description || '-' : '-',
                                        attachment: followUp.attachment || null
                                    });
                                    seenEntries.add(followUpKey);
                                }
                            });
                        }

                        if (event.history && event.history.length > 0) {
                            event.history.forEach(entry => {
                                const changes = entry.changes || {};
                                const instanceDate = entry.instanceDate || entry.date || event.startDate;
                                const historyKey = `${instanceDate}_${entry.action}`;
                                if (!seenEntries.has(historyKey)) {
                                    historyItems.push({
                                        eventId,
                                        isRecurring: true,
                                        date: instanceDate,
                                        time: changes.time ? (changes.time.new || (event.time?.start ? `${event.time.start} - ${event.time.end}` : 'All day')) : (event.time?.start ? `${event.time.start} - ${event.time.end}` : 'All day'),
                                        type: changes.type ? (changes.type.new || event.type || 'N/A') : event.type || 'N/A',
                                        personName: changes.personName ? (changes.personName.new || event.personName || 'N/A') : event.personName || 'N/A',
                                        action: entry.action,
                                        changes: entry.changes || { description: entry.action },
                                        attachment: changes.attachment ? { name: changes.attachment.new, url: changes.attachment.url || '#' } : null
                                    });
                                    seenEntries.add(historyKey);
                                }
                            });
                        }

                        historyItems.sort((a, b) => new Date(a.date) - new Date(b.date));
                    }
                } else {
                    historyItems = getRelatedTasks(selectedTask.id);
                }

                renderHistoryTable(historyItems, title);
                taskHistoryModal.show();
            });
            const formatDateDMY = (date) => {
                const d = new Date(date);
                return `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
            };

            const renderAllTasks = () => {
                let html = `
                    <div class="table-responsive">
                        <table class="table table-bordered task-history-table" id="tasks-table">
                            <thead>
                                <tr>
                                    <th><span>Date</span><div class="resize-handle"></div></th>
                                    <th><span>Title</span><div class="resize-handle"></div></th>
                                    <th><span>Time</span><div class="resize-handle"></div></th>
                                    <th><span>Type</span><div class="resize-handle"></div></th>
                                    <th><span>Person Name</span><div class="resize-handle"></div></th>
                                    <th><span>Status</span><div class="resize-handle"></div></th>
                                </tr>
                            </thead>
                            <tbody id="tasks-content"></tbody>
                        </table>
                    </div>
                `;

                $('#all-tasks-container').html(html);

                const renderTasksContent = () => {
                    let allItems = [];
                    const processedTaskIds = new Set();

                    // Collect the latest task in each task chain
                    Object.keys(tasks).forEach(date => {
                        (tasks[date] || []).forEach(task => {
                            if (task.followUpFrom || processedTaskIds.has(task.id)) return;

                            const taskChain = getAllDescendantTasks({ task, date });
                            if (taskChain.length === 0) return;

                            taskChain.sort((a, b) => new Date(b.date) - new Date(a.date));
                            const latestTask = taskChain[0];

                            taskChain.forEach(t => processedTaskIds.add(t.task.id));

                            allItems.push({
                                type: 'task',
                                date: latestTask.date,
                                task: { ...latestTask.task, date: latestTask.date }
                            });
                        });
                    });

                    // Include recurring events
                    Object.entries(recurringEvents).forEach(([eventId, event]) => {
                        allItems.push({
                            type: 'recurring',
                            date: event.startDate,
                            event: { ...event, id: eventId, date: event.startDate }
                        });
                    });

                    // Custom type detection for dd/mm/yyyy dates
                    $.fn.dataTable.ext.type.detect.unshift(function (value) {
                        if (typeof value === 'string' && value.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                            return 'date-dd-mm-yyyy';
                        }
                        return null;
                    });

                    // Custom sorting for dd/mm/yyyy dates
                    $.fn.dataTable.ext.type.order['date-dd-mm-yyyy-pre'] = function (data) {
                        if (!data) return 0;
                        const [day, month, year] = data.split('/').map(Number);
                        // Create a Date object for sorting (month - 1 because JS months are 0-based)
                        const date = new Date(year, month - 1, day);
                        // Return timestamp for sorting
                        return date.getTime();
                    };

                    // Initialize DataTable
                    const table = $('#tasks-table').DataTable({
                        destroy: true,
                        data: allItems,
                        columns: [
                            {
                                data: null,
                                type: 'date-dd-mm-yyyy', // Use custom date type
                                render: function (data, type) {
                                    const date = new Date(data.type === 'task' ? data.task.date : data.event.date);
                                    if (type === 'display' || type === 'filter') {
                                        // Display as dd/mm/yyyy
                                        return date.toLocaleDateString('en-GB', {
                                            day: '2-digit',
                                            month: '2-digit',
                                            year: 'numeric'
                                        });
                                    }
                                    // For sorting, return dd/mm/yyyy string to trigger custom sorting
                                    return date.toLocaleDateString('en-GB', {
                                        day: '2-digit',
                                        month: '2-digit',
                                        year: 'numeric'
                                    });
                                }
                            },
                            {
                                data: null,
                                render: function (data) {
                                    return data.type === 'task' ? data.task.title : data.event.title;
                                }
                            },
                            {
                                data: null,
                                render: function (data) {
                                    const d = data.type === 'task' ? data.task : data.event;
                                    return d.time?.start && d.time?.end
                                        ? `${d.time.start} - ${d.time.end}`
                                        : d.time?.start || d.time?.end || 'All day';
                                }
                            },
                            {
                                data: null,
                                render: function (data) {
                                    if (data.type === 'task') {
                                        return data.task.type
                                            ? data.task.type.charAt(0).toUpperCase() + data.task.type.slice(1)
                                            : 'Task';
                                    }
                                    return 'Recurring';
                                }
                            },
                            {
                                data: null,
                                render: function (data) {
                                    return (data.type === 'task' ? data.task.personName : data.event.personName) || 'N/A';
                                }
                            },
                            {
                                data: null,
                                render: function (data) {
                                    const d = data.type === 'task' ? data.task : data.event;
                                    const isDue = data.type === 'task' && isTaskDue(d, d.date);
                                    const status = isDue ? 'Due' : d.completed ? 'Completed' : 'Pending';
                                    return `<span class="badge ${isDue ? 'bg-danger' : d.completed ? 'bg-success' : 'bg-secondary'}">${status}</span>`;
                                }
                            }
                        ],
                        pageLength: 10,
                        language: {
                            search: "Search tasks:",
                            searchPlaceholder: "Title, person, or notes"
                        },
                        order: [[0, 'desc']], // Default sort by date descending
                        autoWidth: false, // Disable auto-width to respect custom widths
                        rowCallback: function (row, data) {
                            $(row).addClass('task-item');
                            if (data.type === 'task') {
                                const isDue = isTaskDue(data.task, data.task.date);
                                if (data.task.completed) $(row).addClass('completed');
                                else if (isDue) $(row).addClass('due');
                                $(row).attr('data-task-id', data.task.id).attr('data-date', data.task.date);
                            } else {
                                $(row).attr('data-event-id', data.event.id).attr('data-date', data.event.date);
                            }
                        }
                    });

                    // Click handlers
                    $('#tasks-table tbody').on('click', 'tr[data-task-id]', function () {
                        const taskId = $(this).data('task-id');
                        const date = $(this).data('date');
                        const taskData = findTask(taskId);
                        if (taskData) {
                            selectedTask = taskData.task;
                            selectedDate = new Date(date);
                            currentDate = new Date(date);
                            renderCalendar();
                            showTaskDetails(taskData.task, date);
                            $('#task-details').removeClass('d-none');
                            showPage('calendar-page');
                        }
                    });

                    $('#tasks-table tbody').on('click', 'tr[data-event-id]', function () {
                        const eventId = String($(this).data('event-id'));
                        const date = $(this).data('date');
                        const event = recurringEvents[eventId];
                        if (event) {
                            const instanceId = `${eventId}_${formatDate(new Date(date))}`;
                            selectedTask = { ...event, id: instanceId, isRecurring: true };
                            selectedDate = new Date(date);
                            currentDate = new Date(date);
                            renderCalendar();
                            showTaskDetails(selectedTask, date);
                            $('#task-details').removeClass('d-none');
                            showPage('calendar-page');
                        }
                    });

                    // Initialize column resizing
                    const initColumnResizing = () => {
                        const thEls = document.querySelectorAll('#tasks-table th');
                        thEls.forEach((th, index) => {
                            const handle = th.querySelector('.resize-handle');
                            if (!handle) return;

                            handle.addEventListener('mousedown', (e) => {
                                e.preventDefault();
                                const startX = e.clientX;
                                const startWidth = th.offsetWidth;

                                const onMouseMove = (e) => {
                                    const newWidth = startWidth + (e.clientX - startX);
                                    if (newWidth > 50) { // Minimum width
                                        th.style.width = `${newWidth}px`;
                                        th.style.minWidth = `${newWidth}px`;
                                        // Update DataTable column width
                                        const column = table.column(index);
                                        column.width(`${newWidth}px`);
                                    }
                                };

                                const onMouseUp = () => {
                                    document.removeEventListener('mousemove', onMouseMove);
                                    document.removeEventListener('mouseup', onMouseUp);
                                    // Redraw DataTable to adjust layout
                                    table.draw(false);
                                };

                                document.addEventListener('mousemove', onMouseMove);
                                document.addEventListener('mouseup', onMouseUp);
                            });
                        });
                    };

                    // Call resize initialization after DataTable is drawn
                    table.on('draw', initColumnResizing);
                    initColumnResizing();
                };

                renderTasksContent();
            };


            const renderRecurringEvents = () => {
                const container = $('#recurring-events-container').empty();
                if (!Object.keys(recurringEvents).length) {
                    container.html('<div class="alert alert-info">No recurring events found</div>');
                    return;
                }

                Object.entries(recurringEvents).forEach(([id, event]) => {
                    const patternDesc = event.pattern === 'daily' ? 'Daily' :
                        event.pattern === 'weekly' ? `Weekly on ${event.days.map(d => ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][d]).join(', ')}` :
                        event.pattern === 'monthly' ? `Monthly on day ${event.day}` :
                        `Monthly on ${event.week === 'last' ? 'last' : ['first', 'second', 'third', 'fourth'][event.week - 1]} ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][event.day]}`;
                    const dateRange = event.endDate ? `from ${new Date(event.startDate).toLocaleDateString()} to ${new Date(event.endDate).toLocaleDateString()}` : `from ${new Date(event.startDate).toLocaleDateString()}`;
                    container.append(`
                        <div class="card mb-3" data-event-id="${id}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-1">${event.title}</h5>
                                        <p class="mb-1 text-muted">${patternDesc} ${dateRange}</p>
                                        <p class="mb-0 text-muted small">${event.description || 'No description'}</p>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary me-1 edit-recurring-btn"><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-outline-danger delete-recurring-btn"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `);
                });
            };

            const isSameDay = (d1, d2) => d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
            const formatDate = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

            $('#login-form').submit(async (e) => {
                e.preventDefault();
                try {
                    await signInWithEmailAndPassword(auth, $('#login-email').val(), $('#login-password').val());
                    window.location.reload();
                } catch (error) {
                    alert('Login failed: ' + error.message);
                    $('#login-password').val('');
                }
            });

            $('.logout-btn').click(async () => {
                await signOut(auth);
                window.location.reload();
            });

            $('#prev-month').click(() => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            $('#next-month').click(() => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            $('#today-btn').click(() => {
                currentDate = selectedDate = new Date();
                renderCalendar();
            });

            $(document).on('click', '.calendar-day:not(.empty)', (e) => {
                selectedDate = new Date($(e.currentTarget).data('date'));
                selectedTask = null;
                renderCalendar();
            });

            $(document).on('click', '.task-item', function() {
                const taskId = $(this).data('task-id');
                const isRecurring = $(this).data('is-recurring') === true;
                const taskDate = $(this).data('task-date') || formatDate(selectedDate);

                if (isRecurring) {
                    const eventId = taskId.split('_')[0];
                    const event = recurringEvents[eventId];
                    if (event) {
                        if ($('#tasks-page').hasClass('active')) {
                            showPage('calendar-page');
                        }
                        showTaskDetails({ ...event, id: taskId, isRecurring: true }, taskDate);
                    }
                } else {
                    const task = tasks[taskDate]?.find(t => String(t.id) === String(taskId));
                    if (task) {
                        if ($('#tasks-page').hasClass('active')) {
                            showPage('calendar-page');
                        }
                        showTaskDetails(task, taskDate);
                    }
                }
            });

            $('#add-task-btn, #add-task-global-btn').click(() => {
                $('#taskDate').val(formatDate(selectedDate));
                taskModal.show();
            });
            const hasConflict = (date, startTime, endTime, excludeTaskId = null, excludeEventId = null) => {
                const dateStr = formatDate(new Date(date));
                const dateTasks = (tasks[dateStr] || []).concat(
                    getRecurringInstances(new Date(dateStr))
                        .filter(i => isSameDay(i.date, new Date(dateStr)))
                        .map(i => i.task)
                );

                // Remove duplicates by task ID
                const uniqueTasks = dateTasks.filter((task, index, self) =>
                    index === self.findIndex(t => t.id === task.id)
                );

                // Filter out the task being edited or instances of the recurring event being edited
                const otherTasks = uniqueTasks.filter(t => {
                    if (excludeTaskId && t.id === excludeTaskId) return false;
                    if (excludeEventId && typeof t.id === 'string' && t.id.startsWith(excludeEventId + '_')) return false;
                    return true;
                });

                // Parse time to minutes for comparison
                const parseTimeToMinutes = (timeStr) => {
                    if (!timeStr) return null;
                    const regex = /^(\d{1,2}):(\d{2})\s*(AM|PM)$/i;
                    const match = timeStr.match(regex);
                    if (!match) return null;
                    let hours = parseInt(match[1]);
                    const minutes = parseInt(match[2]);
                    const period = match[3].toUpperCase();
                    if (period === 'PM' && hours !== 12) hours += 12;
                    if (period === 'AM' && hours === 12) hours = 0;
                    return hours * 60 + minutes;
                };

                const isProposedAllDay = !startTime || !endTime;
                const startMinutes = parseTimeToMinutes(startTime);
                const endMinutes = parseTimeToMinutes(endTime);

                if (isProposedAllDay) {
                    // All-day tasks conflict if any other tasks exist on the same date
                    return otherTasks.length > 0;
                }

                // Check for conflicts with all-day tasks
                if (otherTasks.some(t => !t.time || !t.time.start || !t.time.end)) {
                    return true;
                }

                // Check for overlapping timed tasks
                for (const task of otherTasks) {
                    if (task.time && task.time.start && task.time.end) {
                        const taskStartMinutes = parseTimeToMinutes(task.time.start);
                        const taskEndMinutes = parseTimeToMinutes(task.time.end);
                        if (taskStartMinutes === null || taskEndMinutes === null) continue;
                        if (startMinutes < taskEndMinutes && taskStartMinutes < endMinutes) {
                            return true; // Overlap detected
                        }
                    }
                }

                return false;
            };
            const getRecurringDates = (eventData, startCheckDate, endCheckDate) => {
                const dates = [];
                const start = new Date(Math.max(new Date(eventData.startDate), startCheckDate));
                const end = eventData.endDate ? new Date(Math.min(new Date(eventData.endDate), endCheckDate)) : endCheckDate;
                if (start > end) return dates;

                if (eventData.pattern === 'daily') {
                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        dates.push(new Date(d));
                    }
                } else if (eventData.pattern === 'weekly') {
                    const days = eventData.days || [];
                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        if (days.includes(d.getDay())) {
                            dates.push(new Date(d));
                        }
                    }
                } else if (eventData.pattern === 'monthly') {
                    const day = eventData.day;
                    let current = new Date(start);
                    while (current <= end) {
                        const targetDate = new Date(current.getFullYear(), current.getMonth(), day);
                        if (targetDate >= start && targetDate <= end && targetDate.getDate() === day) {
                            dates.push(targetDate);
                        }
                        current.setMonth(current.getMonth() + 1);
                    }
                } else if (eventData.pattern === 'monthly-day') {
                    const week = eventData.week;
                    const day = eventData.day;
                    let current = new Date(start);
                    while (current <= end) {
                        let targetDate;
                        if (week === 'last') {
                            const lastDay = new Date(current.getFullYear(), current.getMonth() + 1, 0);
                            targetDate = new Date(lastDay);
                            targetDate.setDate(lastDay.getDate() - ((lastDay.getDay() - day + 7) % 7));
                        } else {
                            const firstDay = new Date(current.getFullYear(), current.getMonth(), 1);
                            targetDate = new Date(current.getFullYear(), current.getMonth(), 1 + (week - 1) * 7);
                            targetDate.setDate(targetDate.getDate() + ((day - targetDate.getDay() + 7) % 7));
                        }
                        if (targetDate.getMonth() === current.getMonth() && targetDate >= start && targetDate <= end) {
                            dates.push(targetDate);
                        }
                        current.setMonth(current.getMonth() + 1);
                    }
                }
                return dates;
            };

            $('#saveTaskBtn').click(async () => {
                const taskId = $('#taskId').val() || crypto.randomUUID();
                const title = $('#taskTitle').val().trim();
                const personName = $('#personName').val().trim();
                const startTime = getFlatpickrTime('taskStartTime');
                const endTime = getFlatpickrTime('taskEndTime');
                const type = $('#taskType').val();
                const newDate = $('#taskDate').val();
                const time = startTime || endTime ? { start: startTime, end: endTime } : null;

                if (!title || !newDate) {
                    alert('Please fill in all required fields');
                    return;
                }
                // Validate time range
                if (!validateTimeRange(startTime, endTime)) {
                    alert('End time must be after start time.');
                    return;
                }
                // Check for conflicts
                // if (hasConflict(newDate, startTime, endTime, taskId)) {
                //     alert('This task conflicts with an existing task or recurring event on the selected date and time.');
                //     return;
                // }

                const task = {
                    id: taskId,
                    title,
                    personName,
                    time,
                    type,
                    completed: false,
                    followUps: [],
                    followUpFrom: $('#taskId').val() ? findTask(taskId)?.task.followUpFrom : null
                };

                const oldTaskData = $('#taskId').val() ? findTask(taskId) : null;
                const oldDate = oldTaskData ? oldTaskData.date : null;

                if (oldTaskData && oldDate !== newDate) {
                    if (tasks[oldDate]) {
                        tasks[oldDate] = tasks[oldDate].filter(t => String(t.id) !== String(taskId));
                        if (tasks[oldDate].length === 0) {
                            delete tasks[oldDate];
                            await deleteDoc(doc(db, 'users', currentUser.uid, 'tasks', oldDate));
                        } else {
                            await saveTasks(oldDate, tasks[oldDate]);
                        }
                    }
                    tasks[newDate] = tasks[newDate] || [];
                    tasks[newDate].push(task);
                    await saveTasks(newDate, tasks[newDate]);
                } else if (oldTaskData) {
                    tasks[oldDate] = tasks[oldDate].map(t => String(t.id) === String(taskId) ? task : t);
                    await saveTasks(oldDate, tasks[oldDate]);
                } else {
                    tasks[newDate] = tasks[newDate] || [];
                    tasks[newDate].push(task);
                    await saveTasks(newDate, tasks[newDate]);
                }

                taskModal.hide();
                $('#taskForm')[0].reset();
                $('#taskId').val('');
                setFlatpickrTime('taskStartTime', '');
                setFlatpickrTime('taskEndTime', '');
                renderCalendar();
                if ($('#tasks-page').hasClass('active')) renderAllTasks();
            });

            $('#reset-password-btn').click(async () => {
                if (!currentUser) return;
                const email = currentUser.email;
                try {
                    $('#reset-password-btn').prop('disabled', true).text('Sending...');
                    await sendPasswordResetEmail(auth, email);
                    alert('Password reset email sent! Please check your inbox.');
                } catch (error) {
                    console.error('Error sending password reset email:', error);
                    alert('Failed to send password reset email. Please try again.');
                } finally {
                    $('#reset-password-btn').prop('disabled', false).text('Reset Password');
                }
            });
            $('#add-recurring-btn').click(() => {
                $('#recurringForm')[0].reset();
                $('#recurringId').val('');
                $('#weekly-options, #monthly-date-options, #monthly-day-options').addClass('d-none');
                recurringModal.show();
            });

            $('#recurrencePattern').change(function() {
                const pattern = $(this).val();
                $('#weekly-options, #monthly-date-options, #monthly-day-options').addClass('d-none');
                if (pattern === 'weekly') {
                    $('#weekly-options').removeClass('d-none');
                } else if (pattern === 'monthly') {
                    $('#monthly-date-options').removeClass('d-none');
                } else if (pattern === 'monthly-day') {
                    $('#monthly-day-options').removeClass('d-none');
                }
            });

            $('#saveRecurringBtn').click(async () => {
                const eventId = $('#recurringId').val() || String(Date.now());
                const isEditing = !!$('#recurringId').val();
                const pattern = $('#recurrencePattern').val();
                let eventData = {
                    personName: $('#recurringPersonName').val(),
                    title: $('#recurringTitle').val(),
                    time: { start: getFlatpickrTime('recurringStartTime'), end: getFlatpickrTime('recurringEndTime') },
                    type: $('#recurringType').val(),
                    startDate: $('#recurringStartDate').val(),
                    endDate: $('#recurringEndDate').val() || null,
                    pattern,
                    completed: false,
                    history: recurringEvents[eventId]?.history || [],
                    followUps: recurringEvents[eventId]?.followUps || []
                };

                if (!eventData.title || !eventData.personName || !eventData.startDate || !pattern) {
                    return alert('Please fill all required fields');
                }
                // Validate time range
                if (!validateTimeRange(eventData.time.start, eventData.time.end)) {
                    alert('End time must be after start time.');
                    return;
                }

                if (pattern === 'weekly') {
                    eventData.days = [];
                    $('#weekly-options input:checked').each(function() {
                        eventData.days.push(parseInt($(this).val()));
                    });
                    if (!eventData.days.length) return alert('Please select at least one day');
                } else if (pattern === 'monthly') {
                    eventData.day = parseInt($('#monthlyDate').val());
                    if (!eventData.day || eventData.day < 1 || eventData.day > 31) return alert('Please enter a valid day');
                } else if (pattern === 'monthly-day') {
                    eventData.week = $('#monthlyWeek').val();
                    eventData.day = parseInt($('#monthlyDay').val());
                }

                const checkEndDate = new Date();
                checkEndDate.setFullYear(checkEndDate.getFullYear() + 1);
                const datesToCheck = getRecurringDates(eventData, new Date(eventData.startDate), checkEndDate);
                for (const date of datesToCheck) {
                    const dateStr = formatDate(date);
                    // if (hasConflict(dateStr, eventData.time.start, eventData.time.end, null, isEditing ? eventId : null)) {
                    //     alert(`Conflict detected on ${date.toLocaleDateString()}. Cannot save the recurring event.`);
                    //     return;
                    // }
                }

                const oldEvent = recurringEvents[eventId];
                const changes = oldEvent ? {
                    ...(oldEvent.personName !== eventData.personName && { personName: { old: oldEvent.personName, new: eventData.personName } }),
                    ...(oldEvent.title !== eventData.title && { title: { old: oldEvent.title, new: eventData.title } }),
                    ...(oldEvent.type !== eventData.type && { type: { old: oldEvent.type, new: eventData.type } }),
                    ...((oldEvent.time.start !== eventData.time.start || oldEvent.time.end !== eventData.time.end) && {
                        time: { old: `${oldEvent.time.start || ''} - ${oldEvent.time.end || ''}`, new: `${eventData.time.start} - ${eventData.time.end}` }
                    }),
                    ...(oldEvent.startDate !== eventData.startDate && { startDate: { old: oldEvent.startDate, new: eventData.startDate } }),
                    ...(oldEvent.endDate !== eventData.endDate && { endDate: { old: oldEvent.endDate || 'None', new: eventData.endDate || 'None' } }),
                    ...(oldEvent.pattern !== eventData.pattern && { pattern: { old: oldEvent.pattern, new: eventData.pattern } })
                } : {
                    personName: { new: eventData.personName },
                    title: { new: eventData.title },
                    type: { new: eventData.type },
                    time: { new: `${eventData.time.start} - ${eventData.time.end}` },
                    startDate: { new: eventData.startDate },
                    endDate: { new: eventData.endDate || 'None' },
                    pattern: { new: eventData.pattern }
                };

                if (Object.keys(changes).length) {
                    eventData.history.unshift({ date: new Date().toISOString(), action: oldEvent ? 'Event updated' : 'Event created', changes });
                }

                await saveRecurringEvent(eventId, eventData);
                recurringModal.hide();
                $('#recurringForm')[0].reset();
                setFlatpickrTime('recurringStartTime', '');
                setFlatpickrTime('recurringEndTime', '');
                renderCalendar();
            });

            $(document).on('click', '.edit-recurring-btn', function() {
                const eventId = $(this).closest('.card').data('event-id');
                const event = recurringEvents[eventId];
                if (!event) return;

                $('#recurringId').val(eventId);
                $('#recurringPersonName').val(event.personName);
                $('#recurringTitle').val(event.title);
                setFlatpickrTime('recurringStartTime', event.time?.start || '');
                setFlatpickrTime('recurringEndTime', event.time?.end || '');
                $('#recurringType').val(event.type);
                $('#recurringStartDate').val(event.startDate);
                $('#recurringEndDate').val(event.endDate || '');
                $('#recurrencePattern').val(event.pattern).trigger('change');

                if (event.pattern === 'weekly') {
                    event.days.forEach(day => $(`#week-${['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][day]}`).prop('checked', true));
                } else if (event.pattern === 'monthly') {
                    $('#monthlyDate').val(event.day);
                } else if (event.pattern === 'monthly-day') {
                    $('#monthlyWeek').val(event.week);
                    $('#monthlyDay').val(event.day);
                }

                recurringModal.show();
            });
            $(document).on('click', '.delete-recurring-btn', async function() {
                const eventId = $(this).closest('.card').data('event-id');
                if (confirm('Delete this recurring event?')) {
                    await deleteRecurringEvent(eventId);
                    renderCalendar();
                }
            });

            $('#edit-task-btn').click(() => {
                if (!selectedTask) return;
                editOptionsModal.show();
                $('#editOptionsModal').data({
                    'task-id': selectedTask.id,
                    'task-date': formatDate(selectedDate),
                    'is-recurring': selectedTask.isRecurring || false
                });
            });

            // Update button text and style when edit options modal is shown
            $('#editOptionsModal').on('show.bs.modal', function () {
                if (selectedTask) {
                    const markCompletedBtn = $('#markCompletedBtn');
                    const isCompleted = selectedTask.completed;
                    
                    // Update Mark Complete/Incomplete button
                    if (isCompleted) {
                        markCompletedBtn.text('Mark as Incomplete')
                            .removeClass('btn-success')
                            .addClass('btn-secondary');
                    } else {
                        markCompletedBtn.text('Mark as Completed')
                            .removeClass('btn-secondary')
                            .addClass('btn-success');
                    }

                    // Show/hide other buttons based on completion status
                    $('#editTaskDetailsBtn, #openFollowUpModalBtn').toggle(!isCompleted);
                }
            });

            $('#editTaskDetailsBtn').click(() => {
                const { taskId, taskDate, isRecurring } = $('#editOptionsModal').data();
                if (isRecurring) {
                    const eventId = taskId.split('_')[0];
                    const event = recurringEvents[eventId];
                    if (event) {
                        $('#recurringId').val(eventId);
                        $('#recurringPersonName').val(event.personName);
                        $('#recurringTitle').val(event.title);
                        setFlatpickrTime('recurringStartTime', event.time?.start || '');
                        setFlatpickrTime('recurringEndTime', event.time?.end || '');
                        $('#recurringType').val(event.type);
                        $('#recurringStartDate').val(event.startDate);
                        $('#recurringEndDate').val(event.endDate || '');
                        $('#recurrencePattern').val(event.pattern).trigger('change');

                        if (event.pattern === 'weekly') {
                            event.days.forEach(day => $(`#week-${['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][day]}`).prop('checked', true));
                        } else if (event.pattern === 'monthly') {
                            $('#monthlyDate').val(event.day);
                        } else if (event.pattern === 'monthly-day') {
                            $('#monthlyWeek').val(event.week);
                            $('#monthlyDay').val(event.day);
                        }

                        recurringModal.show();
                    }
                } else {
                    if (!tasks[taskDate]) {
                        console.error(`No tasks found for date: ${taskDate}`);
                        return;
                    }
                    const task = tasks[taskDate].find(t => String(t.id) === String(taskId));
                    if (task) {
                        $('#taskId').val(task.id);
                        $('#taskDate').val(taskDate);
                        $('#personName').val(task.personName);
                        $('#taskTitle').val(task.title);
                        setFlatpickrTime('taskStartTime', task.time?.start || '');
                        setFlatpickrTime('taskEndTime', task.time?.end || '');
                        $('#taskType').val(task.type);
                        taskModal.show();
                    }
                }
                editOptionsModal.hide();
            });

            $('#delete-task-btn').click(async () => {
                if (!selectedTask) return;

                if (selectedTask.isRecurring) {
                    const eventId = selectedTask.id.split('_')[0];
                    const instanceDateStr = formatDate(selectedDate);
                    const event = recurringEvents[eventId];

                    if (!event) return;

                    // Prompt user to choose deletion scope
                    const choice = confirm(
                        `Delete this recurring event instance on ${selectedDate.toLocaleDateString()} only?`
                    );

                    if (choice) {
                        // Delete only this instance by adding to exceptions
                        event.exceptions = event.exceptions || [];
                        if (!event.exceptions.includes(instanceDateStr)) {
                            event.exceptions.push(instanceDateStr);
                            event.history = event.history || [];
                            event.history.unshift({
                                date: new Date().toISOString(),
                                action: 'Instance deleted',
                                instanceDate: instanceDateStr,
                                changes: { date: instanceDateStr }
                            });
                            await saveRecurringEvent(eventId, event);
                        }
                    } else {
                        return;
                    }
                } else {
                    // Handle non-recurring task deletion (unchanged)
                    if (!confirm('Delete this task?')) return;
                    const dateStr = formatDate(selectedDate);
                    tasks[dateStr] = tasks[dateStr].filter(t => t.id !== selectedTask.id);
                    if (tasks[dateStr].length === 0) {
                        delete tasks[dateStr];
                        await deleteDoc(doc(db, 'users', currentUser.uid, 'tasks', dateStr));
                    } else {
                        await saveTasks(dateStr, tasks[dateStr]);
                    }
                }

                selectedTask = null;
                renderCalendar();
                $('#task-details').addClass('d-none');
            });


            // Updated click handler to toggle completion status
            $('#markCompletedBtn').click(() => {
                const { taskId, taskDate, isRecurring } = $('#editOptionsModal').data();
                $('#completionDescription').val(''); // Clear previous description
                const isCurrentlyCompleted = isRecurring ? 
                    recurringEvents[taskId.split('_')[0]]?.completed : 
                    tasks[taskDate]?.find(t => String(t.id) === String(taskId))?.completed;
                
                $('#completionModalTitle').text(isCurrentlyCompleted ? 
                    'Mark Task as Incomplete' : 
                    'Mark Task as Completed');
                
                $('#saveCompletionDescriptionBtn').off('click').on('click', async () => {
                    const description = $('#completionDescription').val().trim();
                    const newCompletedStatus = !isCurrentlyCompleted;
                    const action = newCompletedStatus ? 'Marked as completed' : 'Marked as incomplete';

                    if (isRecurring) {
                        const eventId = taskId.split('_')[0];
                        const event = recurringEvents[eventId];
                        if (event) {
                            event.completed = newCompletedStatus;
                            event.history = event.history || [];
                            event.history.unshift({
                                date: new Date().toISOString(),
                                action,
                                changes: { 
                                    completed: { old: !newCompletedStatus, new: newCompletedStatus },
                                    description: description || 'No description provided'
                                }
                            });
                            await saveRecurringEvent(eventId, event);
                            renderCalendar();
                            showTaskDetails({ ...event, id: taskId, isRecurring: true }, taskDate);
                        }
                    } else {
                        if (!tasks[taskDate]) {
                            console.error(`No tasks found for date: ${taskDate}`);
                            return;
                        }
                        const task = tasks[taskDate].find(t => String(t.id) === String(taskId));
                        if (task) {
                            task.completed = newCompletedStatus;
                            task.history = task.history || [];
                            task.history.unshift({
                                date: new Date().toISOString(),
                                action,
                                changes: { 
                                    completed: { old: !newCompletedStatus, new: newCompletedStatus },
                                    description: description || 'No description provided'
                                }
                            });
                            await saveTasks(taskDate, tasks[taskDate]);
                            renderCalendar();
                            showTaskDetails(task, taskDate);
                        }
                    }
                    completionDescriptionModal.hide();
                    editOptionsModal.hide();
                });

                completionDescriptionModal.show();
            });

            $('#openFollowUpModalBtn').click(() => {
                const { taskId, taskDate, isRecurring } = $('#editOptionsModal').data();
                let originalTask;

                if (isRecurring) {
                    const eventId = taskId.split('_')[0];
                    originalTask = recurringEvents[eventId];
                } else {
                    originalTask = tasks[taskDate]?.find(t => String(t.id) === String(taskId));
                }

                if (!originalTask) return;

                // Set form fields
                $('#originalTaskId').val(taskId);
                $('#followTitle').val(originalTask.title || '');
                $('#followPersonName').val(originalTask.personName || '');
                $('#followType').val(originalTask.type || 'call');
                $('#followDescription').val('');
                $('#followUpDate').val(''); // Clear date for non-recurring tasks
                $('#followAttachment').val(''); // Clear attachment

                // Set time fields using Flatpickr
                const startTime = originalTask.time?.start || '';
                const endTime = originalTask.time?.end || '';
                setFlatpickrTime('followStartTime', startTime);
                setFlatpickrTime('followEndTime', endTime);

                // Update modal title and date field visibility
                if (isRecurring) {
                    $('#followUpModal .modal-title').text('Update Recurring Event');
                    $('#followUpDate').closest('.mb-3').addClass('d-none');
                } else {
                    $('#followUpModal .modal-title').text('Add Follow-up Task');
                    $('#followUpDate').closest('.mb-3').removeClass('d-none');
                }

                // Ensure Flatpickr is initialized before showing modal
                initFlatpickr();
                followUpModal.show();
                editOptionsModal.hide();
            });
            $('#saveFollowUpBtn').click(async () => {
                const taskId = $('#originalTaskId').val();
                const isRecurring = $('#editOptionsModal').data('is-recurring');
                const taskDate = $('#followUpDate').val();
                const startTime = getFlatpickrTime('followStartTime');
                const endTime = getFlatpickrTime('followEndTime');
                const attachmentFile = $('#followAttachment')[0].files[0];

                if (!validateTimeRange(startTime, endTime)) {
                    alert('End time must be after start time.');
                    return;
                }

                let attachmentData = null;
                if (attachmentFile) {
                    $('#saveFollowUpBtn').html('<i class="fas fa-spinner fa-spin"></i> Uploading...');
                    try {
                        const attachmentPath = `task-attachments/${currentUser.uid}/${Date.now()}_${attachmentFile.name}`;
                        const downloadURL = await uploadFile(attachmentFile, attachmentPath);
                        attachmentData = {
                            url: downloadURL,
                            name: attachmentFile.name,
                            type: attachmentFile.type,
                            size: attachmentFile.size
                        };
                    } catch (error) {
                        alert('Failed to upload attachment');
                        $('#saveFollowUpBtn').html('Save Follow-up');
                        return;
                    }
                }

                if (isRecurring) {
                    const eventId = taskId.split('_')[0];
                    const event = recurringEvents[eventId];
                    if (!event) return alert('Recurring event not found');

                    const followUpId = Date.now();
                    const followUpData = {
                        id: followUpId,
                        personName: $('#followPersonName').val(),
                        title: $('#followTitle').val(),
                        time: { start: startTime, end: endTime },
                        type: $('#followType').val(),
                        description: $('#followDescription').val(),
                        date: new Date().toISOString().split('T')[0],
                        attachment: attachmentData
                    };

                    if (!followUpData.title || !followUpData.personName) return alert('Please fill all required fields');

                    const checkDate = event.startDate;
                    // if (hasConflict(checkDate, followUpData.time.start, followUpData.time.end, null, eventId)) {
                    //     alert('This follow-up conflicts with an existing task on the event date.');
                    //     return;
                    // }

                    const updatedData = { ...event };
                    updatedData.history = updatedData.history || [];
                    updatedData.followUps = updatedData.followUps || [];

                    const changes = {
                        followUpId: { new: followUpId },
                        followUpTitle: { new: followUpData.title },
                        followUpTime: { new: `${followUpData.time.start} - ${followUpData.time.end}` },
                        followUpPersonName: { new: followUpData.personName },
                        followUpType: { new: followUpData.type },
                        followUpDescription: { new: followUpData.description || 'None' },
                        ...(attachmentData && { followUpAttachment: { new: attachmentData.name } })
                    };

                    updatedData.history.unshift({
                        date: new Date().toISOString(),
                        action: 'Follow-up created',
                        changes
                    });

                    updatedData.followUps.push({
                        id: followUpId,
                        date: followUpData.date,
                        title: followUpData.title,
                        personName: followUpData.personName,
                        time: followUpData.time,
                        type: followUpData.type,
                        description: followUpData.description,
                        attachment: attachmentData
                    });

                    await saveRecurringEvent(eventId, updatedData);
                    followUpModal.hide();
                    renderCalendar();
                    showTaskDetails({ ...updatedData, id: taskId, isRecurring: true }, new Date(event.startDate));
                } else {
                    if (!taskDate) return alert('Please select a follow-up date');
                    // if (hasConflict(taskDate, startTime, endTime)) {
                    //     alert('This follow-up task conflicts with an existing task on this date.');
                    //     return;
                    // }
                    const followUpData = {
                        id: Date.now(),
                        personName: $('#followPersonName').val(),
                        title: $('#followTitle').val(),
                        time: { start: startTime, end: endTime },
                        type: $('#followType').val(),
                        description: $('#followDescription').val(),
                        completed: false,
                        followUpFrom: taskId,
                        history: [],
                        attachment: attachmentData
                    };

                    if (!followUpData.title || !followUpData.personName || !taskDate) return alert('Please fill all required fields');

                    const original = findTask(taskId);
                    if (!original) return;

                    followUpData.history.push({
                        date: new Date().toISOString(),
                        action: 'Follow-up created',
                        changes: {
                            personName: { old: original.task.personName, new: followUpData.personName },
                            title: { old: original.task.title, new: followUpData.title },
                            type: { old: original.task.type, new: followUpData.type },
                            time: { old: `${original.task.time.start || ''} - ${original.task.time.end || ''}`, new: `${followUpData.time.start} - ${followUpData.time.end}` },
                            description: { old: original.task.description || 'None', new: followUpData.description || 'None' },
                            completed: { old: original.task.completed, new: false },
                            ...(attachmentData && { attachment: { new: attachmentData.name } })
                        }
                    });

                    tasks[taskDate] = tasks[taskDate] || [];
                    tasks[taskDate].push(followUpData);

                    original.task.history = original.task.history || [];
                    original.task.history.unshift({
                        date: new Date().toISOString(),
                        action: 'Follow-up created',
                        changes: {
                            followUpId: { new: followUpData.id },
                            followUpTitle: { new: followUpData.title },
                            followUpDate: { new: taskDate },
                            followUpTime: { new: `${followUpData.time.start} - ${followUpData.time.end}` },
                            description: { new: followUpData.description || 'None' },
                            ...(attachmentData && { attachment: { new: attachmentData.name } })
                        }
                    });
                    original.task.followUps = original.task.followUps || [];
                    original.task.followUps.push({ id: followUpData.id, date: taskDate });

                    await Promise.all([
                        saveTasks(taskDate, tasks[taskDate]),
                        saveTasks(original.date, tasks[original.date])
                    ]);

                    renderCalendar();
                    showTaskDetails(original.task, original.date);
                }

                followUpModal.hide();
                $('#followUpForm')[0].reset();
                $('#followAttachment').val('');
                setFlatpickrTime('followStartTime', '');
                setFlatpickrTime('followEndTime', '');
                $('#saveFollowUpBtn').html('Save Follow-up');
            });

            // Profile Handlers
            $('#edit-profile-btn, .nav-link[data-page="profile"]').click((e) => {
                e.preventDefault();
                showPage('profile-page');
            });

            $('#cancel-profile-btn').click(() => showPage('calendar-page'));

            $('#change-profile-pic-btn').click(() => $('#profile-picture-input').click());

            $('#profile-picture-input').change(async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                $('#change-profile-pic-btn').html('<i class="fas fa-spinner fa-spin"></i> Uploading...');
                try {
                    const downloadURL = await uploadFile(file, `profile-pictures/${currentUser.uid}`);
                    if (downloadURL) {
                        userProfileData.photoURL = downloadURL;
                        updateProfileDisplay();
                    }
                } catch (error) {
                    alert('Failed to upload profile picture');
                } finally {
                    $('#change-profile-pic-btn').html('<i class="fas fa-camera me-1"></i> Change Photo');
                }
            });

            $('#profile-form').submit(async (e) => {
                e.preventDefault();
                userProfileData.name = $('#profile-name-input').val();
                userProfileData.gender = $('#profile-gender').val();
                userProfileData.phone = $('#profile-phone').val();
                $('#save-profile-btn').html('<i class="fas fa-spinner fa-spin"></i> Saving...');
                try {
                    if (await saveUserProfile()) {
                        updateProfileDisplay();
                        showPage('calendar-page');
                        alert('Profile updated successfully!');
                    }
                } catch (error) {
                    alert('Failed to save profile');
                } finally {
                    $('#save-profile-btn').html('Save Changes');
                }
            });

            // Navigation
            const showPage = (pageId) => {
                $('.page-content').addClass('d-none').removeClass('active');
                $(`#${pageId}`).removeClass('d-none').addClass('active');
                $('.nav-link').removeClass('active');
                $(`.nav-link[data-page="${pageId.split('-')[0]}"]`).addClass('active');

                if (pageId === 'calendar-page') {
                    renderCalendar();
                } else if (pageId === 'tasks-page') {
                    renderAllTasks();
                } else if (pageId === 'recurring-page') {
                    renderRecurringEvents();
                } else if (pageId === 'profile-page') {
                    updateProfileDisplay();
                }

                if ($(window).width() < 992) {
                    $('#sidebar').removeClass('active');
                    $('#sidebar-overlay').addClass('d-none');
                }
            };

            $('.nav-link').click(function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                showPage(`${page}-page`);
            });

            // Initial setup
            renderCalendar();
            showPage('calendar-page');

            const ensureHistoryConsistency = () => {
                Object.keys(tasks).forEach(date => {
                    tasks[date].forEach(task => {
                        if (!task.history) task.history = [];
                        if (task.followUps) {
                            task.followUps.forEach(followUp => {
                                const followUpTask = findTask(followUp.id);
                                if (followUpTask && !followUpTask.task.followUpFrom) {
                                    followUpTask.task.followUpFrom = task.id;
                                }
                            });
                        }
                    });
                });
                Object.values(recurringEvents).forEach(event => {
                    if (!event.history) event.history = [];
                });
            };

            ensureHistoryConsistency();

            $(window).resize(() => {
                renderCalendar();
                if ($(window).width() >= 992) {
                    $('#sidebar').removeClass('active');
                    $('#sidebar-overlay').addClass('d-none');
                }
            });

        $('#forgot-password-link').click(async (e) => {
            e.preventDefault();
            const email = $('#login-email').val().trim().toLowerCase(); // Normalize to lowercase
            if (!email) {
                alert('Please enter your email address to reset your password.');
                return;
            }
            try {
                $('#forgot-password-link').text('Checking...').addClass('disabled');
                const signInMethods = await fetchSignInMethodsForEmail(auth, email);
                if (signInMethods.length === 0) {
                    // Try sending the password reset email as a fallback to confirm non-existence
                    try {
                        await sendPasswordResetEmail(auth, email);
                        alert('Password reset email sent! Please check your inbox (and spam/junk folder).');
                        $('#login-email').val('');
                        $('#login-password').val('');
                        return;
                    } catch (resetError) {
                        if (resetError.code === 'auth/user-not-found') {
                            alert('No account found with this email address.');
                            return;
                        }
                        throw resetError; // Rethrow other errors
                    }
                }
                
                // If sign-in methods exist or fallback succeeded, send password reset email
                $('#forgot-password-link').text('Sending reset email...');
                await sendPasswordResetEmail(auth, email);
                alert('Password reset email sent! Please check your inbox (and spam/junk folder).');
                $('#login-email').val('');
                $('#login-password').val('');
            } catch (error) {
                let errorMessage = 'Failed to process your request. Please try again.';
                if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Please enter a valid email address.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many attempts. Please try again later.';
                }
                alert(errorMessage);
            } finally {
                $('#forgot-password-link').text('Forgot Password?').removeClass('disabled');
            }
        });
        });
    </script>
</body>
</html>


