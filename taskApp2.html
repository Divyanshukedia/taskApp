<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Existing head content unchanged -->
</head>
<body>
    <!-- Existing HTML content unchanged up to Task Modal -->

    <!-- Task Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Task</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <input type="hidden" id="taskId">
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" id="taskTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Person Name</label>
                            <input type="text" class="form-control" id="personName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Department</label>
                            <select class="form-select" id="taskDepartment" required>
                                <option value="" disabled selected>Select Department</option>
                                <option value="CSS">CSS</option>
                                <option value="HR">HR</option>
                                <option value="IT">IT</option>
                                <option value="Finance">Finance</option>
                                <option value="Sales">Sales</option>
                                <option value="Custom">Custom</option>
                            </select>
                        </div>
                        <div class="mb-3 d-none" id="taskCustomDepartmentContainer">
                            <label class="form-label">Custom Department</label>
                            <input type="text" class="form-control" id="taskCustomDepartment" placeholder="Enter custom department">
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">Start Time</label>
                                <div id="taskStartTime" class="flatpickr-time-container"></div>
                            </div>
                            <div class="col">
                                <label class="form-label">End Time</label>
                                <div id="taskEndTime" class="flatpickr-time-container"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="taskType">
                                <option value="call">Call</option>
                                <option value="meeting">Meeting</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="taskDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="saveTaskBtn">Save Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recurring Event Modal -->
    <div class="modal fade" id="recurringModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Recurring Event</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="recurringForm">
                        <input type="hidden" id="recurringId">
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" id="recurringTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Person Name</label>
                            <input type="text" class="form-control" id="recurringPersonName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Department</label>
                            <select class="form-select" id="recurringDepartment" required>
                                <option value="" disabled selected>Select Department</option>
                                <option value="CSS">CSS</option>
                                <option value="HR">HR</option>
                                <option value="IT">IT</option>
                                <option value="Finance">Finance</option>
                                <option value="Sales">Sales</option>
                                <option value="Custom">Custom</option>
                            </select>
                        </div>
                        <div class="mb-3 d-none" id="recurringCustomDepartmentContainer">
                            <label class="form-label">Custom Department</label>
                            <input type="text" class="form-control" id="recurringCustomDepartment" placeholder="Enter custom department">
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">Start Time</label>
                                <div id="recurringStartTime" class="flatpickr-time-container"></div>
                            </div>
                            <div class="col">
                                <label class="form-label">End Time</label>
                                <div id="recurringEndTime" class="flatpickr-time-container"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="recurringType">
                                <option value="call">Call</option>
                                <option value="meeting">Meeting</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Recurrence Pattern</label>
                            <select class="form-select" id="recurrencePattern" required>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly (Specific Date)</option>
                                <option value="monthly-day">Monthly (Specific Day)</option>
                            </select>
                        </div>
                        <!-- Existing recurrence pattern options unchanged -->
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="saveRecurringBtn">Save Event</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Follow-up Modal -->
    <div class="modal fade" id="followUpModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Follow-up Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="followUpForm">
                        <input type="hidden" id="originalTaskId">
                        <div class="mb-3 d-none">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" id="followTitle" readonly>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">Person Name</label>
                                <textarea class="form-control" id="followPersonName" rows="2" required></textarea>
                            </div>
                            <div class="col">
                                <label class="form-label">Type</label>
                                <select class="form-select" id="followType" required>
                                    <option value="call">Call</option>
                                    <option value="meeting">Meeting</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Department</label>
                            <select class="form-select" id="followDepartment" required>
                                <option value="" disabled selected>Select Department</option>
                                <option value="CSS">CSS</option>
                                <option value="HR">HR</option>
                                <option value="IT">IT</option>
                                <option value="Finance">Finance</option>
                                <option value="Sales">Sales</option>
                                <option value="Custom">Custom</option>
                            </select>
                        </div>
                        <div class="mb-3 d-none" id="followCustomDepartmentContainer">
                            <label class="form-label">Custom Department</label>
                            <input type="text" class="form-control" id="followCustomDepartment" placeholder="Enter custom department">
                        </div>
                        <!-- Existing follow-up form fields unchanged -->
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveFollowUpBtn">Save Follow-up</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Existing HTML content unchanged from Task History Modal onward -->
</body>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail, fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // Firebase configuration (unchanged)
    const firebaseConfig = {
        apiKey: "AIzaSyC87g6-ZLkXW9bPFy3Kn0ZASKYG-EiRArE",
        authDomain: "eventseatmanagement.firebaseapp.com",
        projectId: "eventseatmanagement",
        storageBucket: "eventseatmanagement.firebasestorage.app",
        messagingSenderId: "911745257961",
        appId: "1:911745257961:web:2759656a91df70fd5dbb78",
        measurementId: "G-9K4SXKD384"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app, "gs://eventseatmanagement.firebasestorage.app");

    // App logic
    $(() => {
        // Existing variables and initializations unchanged
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        let currentDate = new Date();
        let selectedDate = new Date();
        let selectedTask = null;
        let tasks = {};
        let recurringEvents = {};
        let currentUser = null;
        let userProfileData = {};
        const taskModal = new bootstrap.Modal('#taskModal');
        const recurringModal = new bootstrap.Modal('#recurringModal');
        const editOptionsModal = new bootstrap.Modal('#editOptionsModal');
        const followUpModal = new bootstrap.Modal('#followUpModal');
        const taskHistoryModal = new bootstrap.Modal('#taskHistoryModal');
        const completionDescriptionModal = new bootstrap.Modal('#completionDescriptionModal');
        let flatpickrInstances = {};

        // New function to toggle custom department input visibility
        const toggleCustomDepartmentInput = (selectId, containerId, customInputId) => {
            const department = $(`#${selectId}`).val();
            const $container = $(`#${containerId}`);
            const $customInput = $(`#${customInputId}`);
            if (department === 'Custom') {
                $container.removeClass('d-none');
                $customInput.prop('required', true);
            } else {
                $container.addClass('d-none');
                $customInput.prop('required', false).val('');
            }
        };

        // Initialize department dropdown listeners
        $('#taskDepartment').change(() => toggleCustomDepartmentInput('taskDepartment', 'taskCustomDepartmentContainer', 'taskCustomDepartment'));
        $('#recurringDepartment').change(() => toggleCustomDepartmentInput('recurringDepartment', 'recurringCustomDepartmentContainer', 'recurringCustomDepartment'));
        $('#followDepartment').change(() => toggleCustomDepartmentInput('followDepartment', 'followCustomDepartmentContainer', 'followCustomDepartment'));

        // Existing validateTimeRange and initFlatpickr functions unchanged
        const validateTimeRange = (startTime, endTime) => {
            if (!startTime || !endTime) return true;
            const regex = /^(\d{1,2}):(\d{2})\s*(AM|PM)$/i;
            const startMatch = startTime.match(regex);
            const endMatch = endTime.match(regex);
            if (!startMatch || !endMatch) return false;

            let startHours = parseInt(startMatch[1]);
            const startMinutes = parseInt(startMatch[2]);
            const startPeriod = startMatch[3].toUpperCase();
            if (startPeriod === 'PM' && startHours !== 12) startHours += 12;
            if (startPeriod === 'AM' && startHours === 12) startHours = 0;
            const startTotalMinutes = startHours * 60 + startMinutes;

            let endHours = parseInt(endMatch[1]);
            const endMinutes = parseInt(endMatch[2]);
            const endPeriod = endMatch[3].toUpperCase();
            if (endPeriod === 'PM' && endHours !== 12) endHours += 12;
            if (endPeriod === 'AM' && endHours === 12) endHours = 0;
            const endTotalMinutes = endHours * 60 + endMinutes;

            return endTotalMinutes > startTotalMinutes;
        };

        function findRootTask(taskId){
            for(const date in taskId)
            {
                const taskId = tasks[date].find(task => task.id === taskId);
                if(!taskId) break;
                if(taskId.followUpFrom){
                    return findRootTask(taskId.followUpFrom);

                }
                return taskId;

                
            }
        }

        const getAllDescendantTasks = (task) => {
            
        }

        const initFlatpickr = () => {
            ['taskStartTime', 'taskEndTime', 'recurringStartTime', 'recurringEndTime', 'followStartTime', 'followEndTime'].forEach(id => {
                if (flatpickrInstances[id]) flatpickrInstances[id].destroy();
                flatpickrInstances[id] = flatpickr(`#${id}`, {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "h:i K",
                    time_24hr: false,
                    minuteIncrement: 10,
                    inline: true,
                    onChange: function(selectedDates, dateStr, instance) {
                        instance.element.dataset.time = dateStr;
                    },
                    // Existing onOpen and onValueUpdate unchanged
                });
            });
        };

        // Existing getImmediateFollowUp, getFlatpickrTime, setFlatpickrTime unchanged

        // Updated getRelatedTasks to include department
        const getRelatedTasks = (taskId) => {
            const rootTask = findRootTask(taskId);
            if (!rootTask) return [];
            const allTasks = getAllDescendantTasks(rootTask);
            allTasks.sort((a, b) => a.date.localeCompare(b.date));
            return allTasks.map(({ task, date }, index) => {
                const followUpTask = getImmediateFollowUp(task.id);
                let notes = followUpTask ? (followUpTask.task.description || '-') : '-';
                let attachment = task.attachment || null;

                if (followUpTask && followUpTask.task.attachment && !task.followUpFrom) {
                    attachment = followUpTask.task.attachment;
                }
                if (task.followUpFrom) {
                    attachment = null;
                }

                if (task.history) {
                    const completionEntry = task.history
                        .filter(entry => entry.action === 'Marked as completed' || entry.action === 'Marked as incomplete')
                        .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                    if (completionEntry && completionEntry.changes?.description) {
                        notes = completionEntry.changes.description;
                    }
                }

                const department = task.department === 'Custom' && task.customDepartment ? task.customDepartment : task.department || 'N/A';

                return {
                    id: task.id,
                    date: date,
                    time: task.time?.start ? `${task.time.start} - ${task.time.end}` : 'All day',
                    type: task.type || 'N/A',
                    personName: task.personName || 'N/A',
                    department: department,
                    notes: notes,
                    attachment: attachment
                };
            });
        };

        // Updated renderHistoryTable to include department
        const renderHistoryTable = (historyItems, title) => {
            $('#task-history-note').text(title || 'Task History');
            $('#task-history-table-head').html(`
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Type</th>
                    <th>Person Name</th>
                    <th>Department</th>
                    <th>Notes</th>
                    <th>Attachment</th>
                </tr>
            `);
            const tbody = $('#task-history-table-body').empty();
            historyItems.forEach((item, index) => {
                const entryDate = new Date(item.date);
                const timeStr = item.time || 'All day';
                const formattedDate = entryDate.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const notes = (item.action === 'Marked as completed' || item.action === 'Marked as incomplete') && item.changes?.description
                    ? item.changes.description
                    : item.notes && item.notes !== '-' ? item.notes
                    : item.action ? item.action
                    : '-';
                const isRecurring = item.isRecurring || (item.taskId && item.taskId.includes('_'));
                const taskId = item.taskId || (isRecurring ? item.eventId + '_' + item.date : item.id);
                const attachmentCell = item.attachment
                    ? `<a href="${item.attachment.url}" target="_blank" download="${item.attachment.name}">${item.attachment.name}</a>`
                    : '-';
                const department = item.department || 'N/A';
                const row = `
                    <tr class="history-row" 
                        data-task-id="${taskId || ''}" 
                        data-date="${item.date}" 
                        data-is-recurring="${isRecurring ? 'true' : 'false'}"
                        style="cursor: pointer;">
                        <td>${formattedDate}</td>
                        <td>${timeStr}</td>
                        <td>${item.type || 'N/A'}</td>
                        <td>${item.personName || 'N/A'}</td>
                        <td>${department}</td>
                        <td>${notes}</td>
                        <td>${attachmentCell}</td>
                    </tr>
                `;
                tbody.append(row);
            });
            if (!historyItems.length) {
                tbody.append('<tr><td colspan="7" class="text-muted">No history available</td></tr>');
            }

            let completionStatus = '';
            const statusEntries = historyItems
                .filter(item => 
                    item.action === 'Marked as completed' && item.changes?.completed?.new === true ||
                    item.action === 'Marked as incomplete' && item.changes?.completed?.new === false
                )
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            if (statusEntries.length > 0) {
                const latestEntry = statusEntries[0];
                const statusDate = new Date(latestEntry.date).toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                if (latestEntry.action === 'Marked as completed') {
                    completionStatus = `Task closed on ${statusDate}`;
                } else if (latestEntry.action === 'Marked as incomplete') {
                    completionStatus = `Task reopened on ${statusDate}`;
                }
            }
            $('#task-completion-status').text(completionStatus);
        };

        // Updated saveTaskBtn click handler to include department
        $('#saveTaskBtn').click(async () => {
            const taskId = $('#taskId').val() || crypto.randomUUID();
            const title = $('#taskTitle').val().trim();
            const personName = $('#personName').val().trim();
            const department = $('#taskDepartment').val();
            const customDepartment = $('#taskCustomDepartment').val().trim();
            const startTime = getFlatpickrTime('taskStartTime');
            const endTime = getFlatpickrTime('taskEndTime');
            const type = $('#taskType').val();
            const newDate = $('#taskDate').val();
            const time = startTime || endTime ? { start: startTime, end: endTime } : null;

            if (!title || !newDate || !department || (department === 'Custom' && !customDepartment)) {
                alert('Please fill in all required fields');
                return;
            }
            if (!validateTimeRange(startTime, endTime)) {
                alert('End time must be after start time.');
                return;
            }

            const task = {
                id: taskId,
                title,
                personName,
                department,
                customDepartment: department === 'Custom' ? customDepartment : null,
                time,
                type,
                completed: false,
                followUps: [],
                followUpFrom: $('#taskId').val() ? findTask(taskId)?.task.followUpFrom : null
            };

            const oldTaskData = $('#taskId').val() ? findTask(taskId) : null;
            const oldDate = oldTaskData ? oldTaskData.date : null;

            if (oldTaskData && oldDate !== newDate) {
                if (tasks[oldDate]) {
                    tasks[oldDate] = tasks[oldDate].filter(t => String(t.id) !== String(taskId));
                    if (tasks[oldDate].length === 0) {
                        delete tasks[oldDate];
                        await deleteDoc(doc(db, 'users', currentUser.uid, 'tasks', oldDate));
                    } else {
                        await saveTasks(oldDate, tasks[oldDate]);
                    }
                }
                tasks[newDate] = tasks[newDate] || [];
                tasks[newDate].push(task);
                await saveTasks(newDate, tasks[newDate]);
            } else if (oldTaskData) {
                tasks[oldDate] = tasks[oldDate].map(t => String(t.id) === String(taskId) ? task : t);
                await saveTasks(oldDate, tasks[oldDate]);
            } else {
                tasks[newDate] = tasks[newDate] || [];
                tasks[newDate].push(task);
                await saveTasks(newDate, tasks[newDate]);
            }

            taskModal.hide();
            $('#taskForm')[0].reset();
            $('#taskId').val('');
            $('#taskDepartment').val('');
            $('#taskCustomDepartment').val('');
            $('#taskCustomDepartmentContainer').addClass('d-none');
            setFlatpickrTime('taskStartTime', '');
            setFlatpickrTime('taskEndTime', '');
            renderCalendar();
            if ($('#tasks-page').hasClass('active')) renderAllTasks();
        });

        // Updated saveRecurringBtn click handler to include department
        $('#saveRecurringBtn').click(async () => {
            const eventId = $('#recurringId').val() || String(Date.now());
            const isEditing = !!$('#recurringId').val();
            const pattern = $('#recurrencePattern').val();
            let eventData = {
                personName: $('#recurringPersonName').val(),
                title: $('#recurringTitle').val(),
                department: $('#recurringDepartment').val(),
                customDepartment: $('#recurringDepartment').val() === 'Custom' ? $('#recurringCustomDepartment').val().trim() : null,
                time: { start: getFlatpickrTime('recurringStartTime'), end: getFlatpickrTime('recurringEndTime') },
                type: $('#recurringType').val(),
                startDate: $('#recurringStartDate').val(),
                endDate: $('#recurringEndDate').val() || null,
                pattern,
                completed: false,
                history: recurringEvents[eventId]?.history || [],
                followUps: recurringEvents[eventId]?.followUps || []
            };

            if (!eventData.title || !eventData.personName || !eventData.startDate || !pattern || !eventData.department || (eventData.department === 'Custom' && !eventData.customDepartment)) {
                return alert('Please fill all required fields');
            }
            if (!validateTimeRange(eventData.time.start, eventData.time.end)) {
                alert('End time must be after start time.');
                return;
            }

            if (pattern === 'weekly') {
                eventData.days = [];
                $('#weekly-options input:checked').each(function() {
                    eventData.days.push(parseInt($(this).val()));
                });
                if (!eventData.days.length) return alert('Please select at least one day');
            } else if (pattern === 'monthly') {
                eventData.day = parseInt($('#monthlyDate').val());
                if (!eventData.day || eventData.day < 1 || eventData.day > 31) return alert('Please enter a valid day');
            } else if (pattern === 'monthly-day') {
                eventData.week = $('#monthlyWeek').val();
                eventData.day = parseInt($('#monthlyDay').val());
            }

            const checkEndDate = new Date();
            checkEndDate.setFullYear(checkEndDate.getFullYear() + 1);
            const datesToCheck = getRecurringDates(eventData, new Date(eventData.startDate), checkEndDate);
            for (const date of datesToCheck) {
                const dateStr = formatDate(date);
                // Conflict check unchanged
            }

            const oldEvent = recurringEvents[eventId];
            const changes = oldEvent ? {
                ...(oldEvent.personName !== eventData.personName && { personName: { old: oldEvent.personName, new: eventData.personName } }),
                ...(oldEvent.title !== eventData.title && { title: { old: oldEvent.title, new: eventData.title } }),
                ...(oldEvent.department !== eventData.department && { department: { old: oldEvent.department, new: eventData.department } }),
                ...(oldEvent.customDepartment !== eventData.customDepartment && { customDepartment: { old: oldEvent.customDepartment || 'None', new: eventData.customDepartment || 'None' } }),
                ...(oldEvent.type !== eventData.type && { type: { old: oldEvent.type, new: eventData.type } }),
                ...((oldEvent.time.start !== eventData.time.start || oldEvent.time.end !== eventData.time.end) && {
                    time: { old: `${oldEvent.time.start || ''} - ${oldEvent.time.end || ''}`, new: `${eventData.time.start} - ${eventData.time.end}` }
                }),
                ...(oldEvent.startDate !== eventData.startDate && { startDate: { old: oldEvent.startDate, new: eventData.startDate } }),
                ...(oldEvent.endDate !== eventData.endDate && { endDate: { old: oldEvent.endDate || 'None', new: eventData.endDate || 'None' } }),
                ...(oldEvent.pattern !== eventData.pattern && { pattern: { old: oldEvent.pattern, new: eventData.pattern } })
            } : {
                personName: { new: eventData.personName },
                title: { new: eventData.title },
                department: { new: eventData.department },
                customDepartment: { new: eventData.customDepartment || 'None' },
                type: { new: eventData.type },
                time: { new: `${eventData.time.start} - ${eventData.time.end}` },
                startDate: { new: eventData.startDate },
                endDate: { new: eventData.endDate || 'None' },
                pattern: { new: eventData.pattern }
            };

            if (Object.keys(changes).length) {
                eventData.history.unshift({ date: new Date().toISOString(), action: oldEvent ? 'Event updated' : 'Event created', changes });
            }

            await saveRecurringEvent(eventId, eventData);
            recurringModal.hide();
            $('#recurringForm')[0].reset();
            $('#recurringDepartment').val('');
            $('#recurringCustomDepartment').val('');
            $('#recurringCustomDepartmentContainer').addClass('d-none');
            setFlatpickrTime('recurringStartTime', '');
            setFlatpickrTime('recurringEndTime', '');
            renderCalendar();
        });

        // Updated edit-recurring-btn click handler to include department
        $(document).on('click', '.edit-recurring-btn', function() {
            const eventId = $(this).closest('.card').data('event-id');
            const event = recurringEvents[eventId];
            if (!event) return;

            $('#recurringId').val(eventId);
            $('#recurringPersonName').val(event.personName);
            $('#recurringTitle').val(event.title);
            $('#recurringDepartment').val(event.department || '').trigger('change');
            $('#recurringCustomDepartment').val(event.customDepartment || '');
            setFlatpickrTime('recurringStartTime', event.time?.start || '');
            setFlatpickrTime('recurringEndTime', event.time?.end || '');
            $('#recurringType').val(event.type);
            $('#recurringStartDate').val(event.startDate);
            $('#recurringEndDate').val(event.endDate || '');
            $('#recurrencePattern').val(event.pattern).trigger('change');

            if (event.pattern === 'weekly') {
                event.days.forEach(day => $(`#week-${['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][day]}`).prop('checked', true));
            } else if (event.pattern === 'monthly') {
                $('#monthlyDate').val(event.day);
            } else if (event.pattern === 'monthly-day') {
                $('#monthlyWeek').val(event.week);
                $('#monthlyDay').val(event.day);
            }

            recurringModal.show();
        });

        // Updated editTaskDetailsBtn click handler to include department
        $('#editTaskDetailsBtn').click(() => {
            const { taskId, taskDate, isRecurring } = $('#editOptionsModal').data();
            if (isRecurring) {
                const eventId = taskId.split('_')[0];
                const event = recurringEvents[eventId];
                if (event) {
                    $('#recurringId').val(eventId);
                    $('#recurringPersonName').val(event.personName);
                    $('#recurringTitle').val(event.title);
                    $('#recurringDepartment').val(event.department || '').trigger('change');
                    $('#recurringCustomDepartment').val(event.customDepartment || '');
                    setFlatpickrTime('recurringStartTime', event.time?.start || '');
                    setFlatpickrTime('recurringEndTime', event.time?.end || '');
                    $('#recurringType').val(event.type);
                    $('#recurringStartDate').val(event.startDate);
                    $('#recurringEndDate').val(event.endDate || '');
                    $('#recurrencePattern').val(event.pattern).trigger('change');

                    if (event.pattern === 'weekly') {
                        event.days.forEach(day => $(`#week-${['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][day]}`).prop('checked', true));
                    } else if (event.pattern === 'monthly') {
                        $('#monthlyDate').val(event.day);
                    } else if (event.pattern === 'monthly-day') {
                        $('#monthlyWeek').val(event.week);
                        $('#monthlyDay').val(event.day);
                    }

                    recurringModal.show();
                }
            } else {
                if (!tasks[taskDate]) {
                    console.error(`No tasks found for date: ${taskDate}`);
                    return;
                }
                const task = tasks[taskDate].find(t => String(t.id) === String(taskId));
                if (task) {
                    $('#taskId').val(task.id);
                    $('#taskDate').val(taskDate);
                    $('#personName').val(task.personName);
                    $('#taskTitle').val(task.title);
                    $('#taskDepartment').val(task.department || '').trigger('change');
                    $('#taskCustomDepartment').val(task.customDepartment || '');
                    setFlatpickrTime('taskStartTime', task.time?.start || '');
                    setFlatpickrTime('taskEndTime', task.time?.end || '');
                    $('#taskType').val(task.type);
                    taskModal.show();
                }
            }
            editOptionsModal.hide();
        });

        // Updated openFollowUpModalBtn click handler to include department
        $('#openFollowUpModalBtn').click(() => {
            const { taskId, taskDate, isRecurring } = $('#editOptionsModal').data();
            let originalTask;

            if (isRecurring) {
                const eventId = taskId.split('_')[0];
                originalTask = recurringEvents[eventId];
            } else {
                originalTask = tasks[taskDate]?.find(t => String(t.id) === String(taskId));
            }

            if (!originalTask) return;

            $('#originalTaskId').val(taskId);
            $('#followTitle').val(originalTask.title || '');
            $('#followPersonName').val(originalTask.personName || '');
            $('#followDepartment').val(originalTask.department || '').trigger('change');
            $('#followCustomDepartment').val(originalTask.customDepartment || '');
            $('#followType').val(originalTask.type || 'call');
            $('#followDescription').val('');
            $('#followUpDate').val('');
            $('#followAttachment').val('');

            const startTime = originalTask.time?.start || '';
            const endTime = originalTask.time?.end || '';
            setFlatpickrTime('followStartTime', startTime);
            setFlatpickrTime('followEndTime', endTime);

            if (isRecurring) {
                $('#followUpModal .modal-title').text('Update Recurring Event');
                $('#followUpDate').closest('.mb-3').addClass('d-none');
            } else {
                $('#followUpModal .modal-title').text('Add Follow-up Task');
                $('#followUpDate').closest('.mb-3').removeClass('d-none');
            }

            initFlatpickr();
            followUpModal.show();
            editOptionsModal.hide();
        });

        // Updated saveFollowUpBtn click handler to include department
        $('#saveFollowUpBtn').click(async () => {
            const taskId = $('#originalTaskId').val();
            const isRecurring = $('#editOptionsModal').data('is-recurring');
            const taskDate = $('#followUpDate').val();
            const startTime = getFlatpickrTime('followStartTime');
            const endTime = getFlatpickrTime('followEndTime');
            const department = $('#followDepartment').val();
            const customDepartment = $('#followCustomDepartment').val().trim();
            const attachmentFile = $('#followAttachment')[0].files[0];

            if (!validateTimeRange(startTime, endTime)) {
                alert('End time must be after start time.');
                return;
            }

            let attachmentData = null;
            if (attachmentFile) {
                $('#saveFollowUpBtn').html('<i class="fas fa-spinner fa-spin"></i> Uploading...');
                try {
                    const attachmentPath = `task-attachments/${currentUser.uid}/${Date.now()}_${attachmentFile.name}`;
                    const downloadURL = await uploadFile(attachmentFile, attachmentPath);
                    attachmentData = {
                        url: downloadURL,
                        name: attachmentFile.name,
                        type: attachmentFile.type,
                        size: attachmentFile.size
                    };
                } catch (error) {
                    alert('Failed to upload attachment');
                    $('#saveFollowUpBtn').html('Save Follow-up');
                    return;
                }
            }

            if (isRecurring) {
                const eventId = taskId.split('_')[0];
                const event = recurringEvents[eventId];
                if (!event) return alert('Recurring event not found');

                const followUpId = Date.now();
                const followUpData = {
                    id: followUpId,
                    personName: $('#followPersonName').val(),
                    title: $('#followTitle').val(),
                    department,
                    customDepartment: department === 'Custom' ? customDepartment : null,
                    time: { start: startTime, end: endTime },
                    type: $('#followType').val(),
                    description: $('#followDescription').val(),
                    date: new Date().toISOString().split('T')[0],
                    attachment: attachmentData
                };

                if (!followUpData.title || !followUpData.personName || !followUpData.department || (followUpData.department === 'Custom' && !followUpData.customDepartment)) {
                    return alert('Please fill all required fields');
                }

                const checkDate = event.startDate;
                // Conflict check unchanged

                const updatedData = { ...event };
                updatedData.history = updatedData.history || [];
                updatedData.followUps = updatedData.followUps || [];

                const changes = {
                    followUpId: { new: followUpId },
                    followUpTitle: { new: followUpData.title },
                    followUpTime: { new: `${followUpData.time.start} - ${followUpData.time.end}` },
                    followUpPersonName: { new: followUpData.personName },
                    followUpDepartment: { new: followUpData.department },
                    followUpCustomDepartment: { new: followUpData.customDepartment || 'None' },
                    followUpType: { new: followUpData.type },
                    followUpDescription: { new: followUpData.description || 'None' },
                    ...(attachmentData && { followUpAttachment: { new: attachmentData.name } })
                };

                updatedData.history.unshift({
                    date: new Date().toISOString(),
                    action: 'Follow-up created',
                    changes
                });

                updatedData.followUps.push({
                    id: followUpId,
                    date: followUpData.date,
                    title: followUpData.title,
                    personName: followUpData.personName,
                    department: followUpData.department,
                    customDepartment: followUpData.customDepartment,
                    time: followUpData.time,
                    type: followUpData.type,
                    description: followUpData.description,
                    attachment: attachmentData
                });

                await saveRecurringEvent(eventId, updatedData);
                followUpModal.hide();
                renderCalendar();
                showTaskDetails({ ...updatedData, id: taskId, isRecurring: true }, new Date(event.startDate));
            } else {
                if (!taskDate) return alert('Please select a follow-up date');
                // Conflict check unchanged
                const followUpData = {
                    id: Date.now(),
                    personName: $('#followPersonName').val(),
                    title: $('#followTitle').val(),
                    department,
                    customDepartment: department === 'Custom' ? customDepartment : null,
                    time: { start: startTime, end: endTime },
                    type: $('#followType').val(),
                    description: $('#followDescription').val(),
                    completed: false,
                    followUpFrom: taskId,
                    history: [],
                    attachment: attachmentData
                };

                if (!followUpData.title || !followUpData.personName || !taskDate || !followUpData.department || (followUpData.department === 'Custom' && !followUpData.customDepartment)) {
                    return alert('Please fill all required fields');
                }

                const original = findTask(taskId);
                if (!original) return;

                followUpData.history.push({
                    date: new Date().toISOString(),
                    action: 'Follow-up created',
                    changes: {
                        personName: { old: original.task.personName, new: followUpData.personName },
                        title: { old: original.task.title, new: followUpData.title },
                        department: { old: original.task.department, new: followUpData.department },
                        customDepartment: { old: original.task.customDepartment || 'None', new: followUpData.customDepartment || 'None' },
                        type: { old: original.task.type, new: followUpData.type },
                        time: { old: `${original.task.time.start || ''} - ${original.task.time.end || ''}`, new: `${followUpData.time.start} - ${followUpData.time.end}` },
                        description: { old: original.task.description || 'None', new: followUpData.description || 'None' },
                        completed: { old: original.task.completed, new: false },
                        ...(attachmentData && { attachment: { new: attachmentData.name } })
                    }
                });

                tasks[taskDate] = tasks[taskDate] || [];
                tasks[taskDate].push(followUpData);

                original.task.history = original.task.history || [];
                original.task.history.unshift({
                    date: new Date().toISOString(),
                    action: 'Follow-up created',
                    changes: {
                        followUpId: { new: followUpData.id },
                        followUpTitle: { new: followUpData.title },
                        followUpDate: { new: taskDate },
                        followUpDepartment: { new: followUpData.department },
                        followUpCustomDepartment: { new: followUpData.customDepartment || 'None' },
                        followUpTime: { new: `${followUpData.time.start} - ${followUpData.time.end}` },
                        description: { new: followUpData.description || 'None' },
                        ...(attachmentData && { attachment: { new: attachmentData.name } })
                    }
                });
                original.task.followUps = original.task.followUps || [];
                original.task.followUps.push({ id: followUpData.id, date: taskDate });

                await Promise.all([
                    saveTasks(taskDate, tasks[taskDate]),
                    saveTasks(original.date, tasks[original.date])
                ]);

                renderCalendar();
                showTaskDetails(original.task, original.date);
            }

            followUpModal.hide();
            $('#followUpForm')[0].reset();
            $('#followDepartment').val('');
            $('#followCustomDepartment').val('');
            $('#followCustomDepartmentContainer').addClass('d-none');
            $('#followAttachment').val('');
            setFlatpickrTime('followStartTime', '');
            setFlatpickrTime('followEndTime', '');
            $('#saveFollowUpBtn').html('Save Follow-up');
        });

        // Existing functions (renderAllTasks, renderRecurringEvents, etc.) unchanged unless specified
        // Updated renderAllTasks to include department in the table
        const renderAllTasks = () => {
            let html = `
                <div class="table-responsive">
                    <table class="table table-bordered task-history-table" id="tasks-table">
                        <thead>
                            <tr>
                                <th><span>Date</span><div class="resize-handle"></div></th>
                                <th><span>Title</span><div class="resize-handle"></div></th>
                                <th><span>Time</span><div class="resize-handle"></div></th>
                                <th><span>Type</span><div class="resize-handle"></div></th>
                                <th><span>Person Name</span><div class="resize-handle"></div></th>
                                <th><span>Department</span><div class="resize-handle"></div></th>
                                <th><span>Status</span><div class="resize-handle"></div></th>
                            </tr>
                        </thead>
                        <tbody id="tasks-content"></tbody>
                    </table>
                </div>
            `;

            $('#all-tasks-container').html(html);

            const renderTasksContent = () => {
                let allItems = [];
                const processedTaskIds = new Set();

                Object.keys(tasks).forEach(date => {
                    (tasks[date] || []).forEach(task => {
                        if (task.followUpFrom || processedTaskIds.has(task.id)) return;

                        const taskChain = getAllDescendantTasks({ task, date });
                        if (taskChain.length === 0) return;

                        taskChain.sort((a, b) => new Date(b.date) - new Date(a.date));
                        const latestTask = taskChain[0];

                        taskChain.forEach(t => processedTaskIds.add(t.task.id));

                        allItems.push({
                            type: 'task',
                            date: latestTask.date,
                            task: { ...latestTask.task, date: latestTask.date }
                        });
                    });
                });

                Object.entries(recurringEvents).forEach(([eventId, event]) => {
                    allItems.push({
                        type: 'recurring',
                        date: event.startDate,
                        event: { ...event, id: eventId, date: event.startDate }
                    });
                });

                $.fn.dataTable.ext.type.detect.unshift(function (value) {
                    if (typeof value === 'string' && value.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                        return 'date-dd-mm-yyyy';
                    }
                    return null;
                });

                $.fn.dataTable.ext.type.order['date-dd-mm-yyyy-pre'] = function (data) {
                    if (!data) return 0;
                    const [day, month, year] = data.split('/').map(Number);
                    const date = new Date(year, month - 1, day);
                    return date.getTime();
                };

                const table = $('#tasks-table').DataTable({
                    destroy: true,
                    data: allItems,
                    columns: [
                        {
                            data: null,
                            type: 'date-dd-mm-yyyy',
                            render: function (data, type) {
                                const date = new Date(data.type === 'task' ? data.task.date : data.event.date);
                                if (type === 'display' || type === 'filter') {
                                    return date.toLocaleDateString('en-GB', {
                                        day: '2-digit',
                                        month: '2-digit',
                                        year: 'numeric'
                                    });
                                }
                                return date.toLocaleDateString('en-GB', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric'
                                });
                            }
                        },
                        {
                            data: null,
                            render: function (data) {
                                return data.type === 'task' ? data.task.title : data.event.title;
                            }
                        },
                        {
                            data: null,
                            render: function (data) {
                                const d = data.type === 'task' ? data.task : data.event;
                                return d.time?.start && d.time?.end
                                    ? `${d.time.start} - ${d.time.end}`
                                    : d.time?.start || d.time?.end || 'All day';
                            }
                        },
                        {
                            data: null,
                            render: function (data) {
                                if (data.type === 'task') {
                                    return data.task.type
                                        ? data.task.type.charAt(0).toUpperCase() + data.task.type.slice(1)
                                        : 'Task';
                                }
                                return 'Recurring';
                            }
                        },
                        {
                            data: null,
                            render: function (data) {
                                return (data.type === 'task' ? data.task.personName : data.event.personName) || 'N/A';
                            }
                        },
                        {
                            data: null,
                            render: function (data) {
                                const d = data.type === 'task' ? data.task : data.event;
                                return d.department === 'Custom' && d.customDepartment ? d.customDepartment : d.department || 'N/A';
                            }
                        },
                        {
                            data: null,
                            render: function (data) {
                                const d = data.type === 'task' ? data.task : data.event;
                                const isDue = data.type === 'task' && isTaskDue(d, d.date);
                                const status = isDue ? 'Due' : d.completed ? 'Completed' : 'Pending';
                                return `<span class="badge ${isDue ? 'bg-danger' : d.completed ? 'bg-success' : 'bg-secondary'}">${status}</span>`;
                            }
                        }
                    ],
                    pageLength: 10,
                    language: {
                        search: "Search tasks:",
                        searchPlaceholder: "Title, person, or notes"
                    },
                    order: [[0, 'desc']],
                    autoWidth: false,
                    rowCallback: function (row, data) {
                        $(row).addClass('task-item');
                        if (data.type === 'task') {
                            const isDue = isTaskDue(data.task, data.task.date);
                            if (data.task.completed) $(row).addClass('completed');
                            else if (isDue) $(row).addClass('due');
                            $(row).attr('data-task-id', data.task.id).attr('data-date', data.task.date);
                        } else {
                            $(row).attr('data-event-id', data.event.id).attr('data-date', data.event.date);
                        }
                    }
                });

                // Click handlers unchanged
                $('#tasks-table tbody').on('click', 'tr[data-task-id]', function () {
                    const taskId = $(this).data('task-id');
                    const date = $(this).data('date');
                    const taskData = findTask(taskId);
                    if (taskData) {
                        selectedTask = taskData.task;
                        selectedDate = new Date(date);
                        currentDate = new Date(date);
                        showPage('calendar-page');
                        renderCalendar();
                        showTaskDetails(taskData.task, date);
                        $('#task-details').removeClass('d-none');
                        $('#editOptionsModal').data({
                            'task-id': taskId,
                            'task-date': date,
                            'is-recurring': false
                        });
                        editOptionsModal.show();
                    }
                });

                $('#tasks-table tbody').on('click', 'tr[data-event-id]', function () {
                    const eventId = String($(this).data('event-id'));
                    const date = $(this).data('date');
                    const event = recurringEvents[eventId];
                    if (event) {
                        const instanceId = `${eventId}_${formatDate(new Date(date))}`;
                        selectedTask = { ...event, id: instanceId, isRecurring: true };
                        selectedDate = new Date(date);
                        currentDate = new Date(date);
                        showPage('calendar-page');
                        renderCalendar();
                        showTaskDetails(selectedTask, date);
                        $('#task-details').removeClass('d-none');
                        $('#editOptionsModal').data({
                            'task-id': instanceId,
                            'task-date': date,
                            'is-recurring': true
                        });
                        editOptionsModal.show();
                    }
                });

                const initColumnResizing = () => {
                    const thEls = document.querySelectorAll('#tasks-table th');
                    thEls.forEach((th, index) => {
                        const handle = th.querySelector('.resize-handle');
                        if (!handle) return;

                        handle.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            const startX = e.clientX;
                            const startWidth = th.offsetWidth;

                            const onMouseMove = (e) => {
                                const newWidth = startWidth + (e.clientX - startX);
                                if (newWidth > 50) {
                                    th.style.width = `${newWidth}px`;
                                    th.style.minWidth = `${newWidth}px`;
                                    const column = table.column(index);
                                    column.width(`${newWidth}px`);
                                }
                            };

                            const onMouseUp = () => {
                                document.removeEventListener('mousemove', onMouseMove);
                                document.removeEventListener('mouseup', onMouseUp);
                                table.draw(false);
                            };

                            document.addEventListener('mousemove', onMouseMove);
                            document.addEventListener('mouseup', onMouseUp);
                        });
                    });
                };

                table.on('draw', initColumnResizing);
                initColumnResizing();
            };

            renderTasksContent();
        };

        // Existing functions (showTaskDetails, renderCalendar, etc.) unchanged
        // All other existing event handlers and logic unchanged
    });
</script>
</html>